<!-- Chosen Palette: Indigo/Green Minimalist -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šç¶²å¤§é›™ç¶²å®¢æˆ¶å·¥é …è‡ªå‹•åŒ–ä»‹é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styling for Inter font and chart container control */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styling for inputs */
        .form-select {
            transition: all 0.15s ease-in-out;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234B5563' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3csvg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .form-select:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        /* Adjusted font size for primary output text */
        .primary-output-text {
            font-size: 1.25rem; /* Smaller text for primary output (was 1.5rem) */
            font-weight: 700;
            color: #4338CA; /* Indigo 700 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Main Content Container -->
    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header Section -->
        <header class="p-6 bg-indigo-700 text-white flex flex-col sm:flex-row justify-between items-start sm:items-center rounded-t-xl">
            <h1 class="text-2xl font-bold tracking-tight mb-2 sm:mb-0">ä»Šç¶²å¤§é›™ç¶²å®¢æˆ¶å·¥é …è‡ªå‹•åŒ–ä»‹é¢</h1>
            <span class="text-sm opacity-80 font-medium bg-indigo-800 px-3 py-1 rounded-full">å·¥é …é‚è¼¯é©—è­‰èˆ‡è¼¸å‡º</span>
        </header>

        <div class="p-6 sm:p-8 lg:flex lg:space-x-8 lg:items-stretch">
            
            <!-- 1. Form Section å¡«å¯«å€ (Input Area) -->
            <div class="lg:w-3/5 space-y-6">
                <h2 class="text-xl font-semibold mb-6 pb-2 border-b border-gray-200 text-indigo-800 flex items-center">
                    <span class="mr-2">ğŸ“</span>
                    å®¢æˆ¶æƒ…å¢ƒè¨­å®šå€ (å³æ™‚é‹ç®—å·¥é …)
                </h2>

                <form id="workOrderForm" class="space-y-6">
                    
                    <!-- å€å¡Šä¸€ï¼šæ–¹æ¡ˆè³‡è¨Š (ç”¨æ–¼æ¨™é¡Œæˆ–å‚™è¨») -->
                    <div class="p-4 bg-indigo-50/50 rounded-xl border border-indigo-300 shadow-sm">
                        <h3 class="text-lg font-bold mb-4 text-indigo-700 flex items-center">
                            <span class="mr-2 text-xl">â¶</span>
                            å€å¡Šä¸€ï¼šæ–¹æ¡ˆè³‡è¨Š (ç”¨æ–¼é€Ÿè¨˜èˆ‡æ¨™é¡Œ)
                        </h3>
                        <!-- Grid updated to 4 columns -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            
                            <!-- æ–¹æ¡ˆç‹€æ…‹ (Select) -->
                            <div class="space-y-1">
                                <label for="planStatus" class="block text-sm font-medium text-gray-700">æ–¹æ¡ˆç‹€æ…‹ <span class="text-red-500">*</span></label>
                                <select id="planStatus" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="æ–°è¾¦">æ–°è¾¦</option>
                                    <option value="æ”œç¢¼">æ”œç¢¼</option>
                                </select>
                            </div>

                            <!-- ç”³è¾¦é›»ä¿¡ (Select) -->
                            <div class="space-y-1">
                                <label for="telecomProvider" class="block text-sm font-medium text-gray-700">ç”³è¾¦é›»ä¿¡ <span class="text-red-500">*</span></label>
                                <select id="telecomProvider" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="ä¸­è¯">ä¸­è¯</option>
                                    <option value="é å‚³">é å‚³</option>
                                </select>
                            </div>
                            
                            <!-- æœˆè³‡è²» (Select) -->
                            <div class="space-y-1">
                                <label for="monthlyFee" class="block text-sm font-medium text-gray-700">æœˆè³‡è²» <span class="text-red-500">*</span></label>
                                <select id="monthlyFee" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>

                            <!-- ç¶²è·¯æœˆä»½ (Select) -->
                            <div class="space-y-1">
                                <label for="internetMonths" class="block text-sm font-medium text-gray-700">ç¶²è·¯æœˆä»½ <span class="text-red-500">*</span></label>
                                <select id="internetMonths" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="24+1">24+1</option>
                                    <option value="24+2">24+2</option>
                                    <option value="24+3">24+3</option>
                                    <option value="24+4">24+4</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="13">13</option>
                                    <option value="16">16</option>
                                    <option value="19">19</option>
                                    <option value="24">24</option>
                                    <option value="30">30</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- å€å¡ŠäºŒï¼šç´°ç¯€èˆ‡å·¥é …ä¾æ“š (å‰©ä¸‹æ¬„ä½) -->
                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-300 shadow-sm">
                        <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center">
                            <span class="mr-2 text-xl">â·</span>
                            å€å¡ŠäºŒï¼šå·¥é …è¨ˆç®—ç´°ç¯€
                        </h3>
                        <!-- Input Grid for Block 2 (now only 4 fields) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <!-- ä»Šç¶²ç¶²è·¯ (Select) -->
                            <div class="space-y-1">
                                <label for="jingnetStatus" class="block text-sm font-medium text-gray-700">ä»Šç¶²ç¶²è·¯ <span class="text-red-500">*</span></label>
                                <select id="jingnetStatus" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="æ–°è£æ©Ÿå·²ä»˜æ¬¾">æ–°è£æ©Ÿå·²ä»˜æ¬¾</option>
                                    <option value="æ–°è£æ©Ÿæœªä»˜æ¬¾">æ–°è£æ©Ÿæœªä»˜æ¬¾</option>
                                    <option value="æœŸä¸­å®¢">æœŸä¸­å®¢</option>
                                    <option value="çºŒç´„å®¢å·²ä»˜æ¬¾">çºŒç´„å®¢å·²ä»˜æ¬¾</option>
                                    <option value="çºŒç´„å®¢æœªä»˜æ¬¾">çºŒç´„å®¢æœªä»˜æ¬¾</option>
                                </select>
                            </div>

                            <!-- åŸé›»ä¿¡åˆç´„ (Select) -->
                            <div class="space-y-1">
                                <label for="originalContract" class="block text-sm font-medium text-gray-700">åŸé›»ä¿¡åˆç´„ <span class="text-red-500">*</span></label>
                                <select id="originalContract" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="é ˆè§£ç´„">é ˆè§£ç´„</option>
                                    <option value="ç„¡åˆç´„">ç„¡åˆç´„</option>
                                    <option value="28å¤©å…§">28å¤©å…§</option>
                                </select>
                            </div>
                            
                            <!-- æ¬¾é … (Select) -->
                            <div class="space-y-1">
                                <label for="paymentType" class="block text-sm font-medium text-gray-700">æ¬¾é … <span class="text-red-500">*</span></label>
                                <select id="paymentType" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="é ç¹³é‡‘">é ç¹³é‡‘</option>
                                    <option value="ç„¡">ç„¡</option>
                                </select>
                            </div>
                            
                            <!-- SIMå¡ (Select) -->
                            <div class="space-y-1">
                                <label for="simDelivery" class="block text-sm font-medium text-gray-700">SIMå¡æ´¾é€æ–¹å¼ <span class="text-red-500">*</span></label>
                                <select id="simDelivery" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <!-- Options populated by JS dynamically based on telecom provider -->
                                </select>
                            </div>
                            
                        </div>

                        <!-- å…¶ä»–å·¥é …(è«‹èªªæ˜) -->
                        <div class="space-y-1 pt-6">
                            <label for="otherTaskDescription" class="block text-sm font-medium text-gray-700">å…¶ä»–å·¥é …èªªæ˜ (è‹¥æœ‰å‰‡æœƒè‡ªå‹•åŠ å…¥æ¸…å–®)</label>
                            <textarea id="otherTaskDescription" rows="2" placeholder="è«‹è¼¸å…¥éœ€è¦æ‰‹å‹•è¿½è¹¤æˆ–ç‰¹æ®Šè™•ç†çš„ä»»å‹™èªªæ˜" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                        </div>
                    </div>

                </form>
            </div>

            <!-- 2. Output Section å·¥é …å€ (Result Area) -->
            <div class="lg:w-2/5 mt-8 lg:mt-0 space-y-8">
                
                <!-- === Primary Output (å€å¡Šä¸€çµæœ) === -->
                <div class="p-0">
                    <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-indigo-200 text-indigo-700 flex items-center">
                        <span class="mr-2">ğŸ’¡</span>
                        å€å¡Šä¸€ï¼šæ–¹æ¡ˆé€Ÿè¨˜ (å¿«é€Ÿè¤‡è£½ç”¨)
                    </h2>
                    
                    <div id="primaryOutput" class="p-4 border-2 border-indigo-500 rounded-xl bg-indigo-50 min-h-16 shadow-inner transition duration-300 flex items-center justify-center">
                        <p class="text-gray-500 italic">è«‹åœ¨å·¦å´å¡«å¯«å€å¡Šä¸€è³‡è¨Š</p>
                    </div>
                    
                    <button id="copyPrimaryButton" class="mt-4 w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.005] flex items-center justify-center">
                        <span class="mr-2">ğŸ“‹</span>
                        è¤‡è£½æ–¹æ¡ˆé€Ÿè¨˜
                    </button>
                </div>


                <!-- === Secondary Output (å€å¡ŠäºŒçµæœ/å·¥é …æ¸…å–®) === -->
                <div class="p-0">
                    <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-200 text-green-700 flex items-center">
                        <span class="mr-2">âœ…</span>
                        å€å¡ŠäºŒï¼šè‡ªå‹•ç”¢å‡ºå·¥é …æ¸…å–®
                    </h2>
                    
                    <!-- Work Items Output -->
                    <div id="workItemsOutput" class="space-y-4 p-4 border-2 border-green-300 rounded-xl bg-green-50 min-h-64 shadow-inner transition duration-300">
                        <p class="text-gray-500 italic text-center pt-8">è«‹åœ¨å·¦å´å®Œæ•´å¡«å¯«æ‰€æœ‰å®¢æˆ¶è³‡è¨Šï¼Œå·¥é …æœƒå³æ™‚è‡ªå‹•ç”Ÿæˆã€‚</p>
                    </div>
                    
                    <!-- Red Warning for Chunghwa Mid-Term -->
                    <div id="chunghwaMidTermWarning" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 font-semibold rounded-lg text-sm shadow-md">
                        <!-- æé†’èªå°‡ç”± JavaScript è¼‰å…¥ -->
                    </div>

                    <!-- Action Button & Confirmation -->
                    <button id="copyWorkItemsButton" class="mt-6 w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.005] flex items-center justify-center">
                        <span class="mr-2">ğŸ“</span>
                        è¤‡è£½å·¥é …æ¸…å–®
                    </button>
                </div>
                
                <div id="confirmationMessage" class="hidden mt-4 p-3 text-center rounded-lg font-medium shadow-md">
                    <!-- Confirmation message will appear here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('workOrderForm');
            
            // Output elements for Primary Section (Block 1)
            const primaryOutputDiv = document.getElementById('primaryOutput');
            const copyPrimaryButton = document.getElementById('copyPrimaryButton');

            // Output elements for Secondary Section (Block 2)
            const workItemsOutputDiv = document.getElementById('workItemsOutput');
            const copyWorkItemsButton = document.getElementById('copyWorkItemsButton');
            
            const confirmationMessage = document.getElementById('confirmationMessage');
            const chunghwaMidTermWarning = document.getElementById('chunghwaMidTermWarning');
            
            // å–å¾—æ‰€æœ‰ Select å…ƒç´ 
            const telecomProviderSelect = document.getElementById('telecomProvider');
            const monthlyFeeSelect = document.getElementById('monthlyFee');
            const internetMonthsSelect = document.getElementById('internetMonths');
            const paymentTypeSelect = document.getElementById('paymentType');
            const planStatusSelect = document.getElementById('planStatus'); 
            const simDeliverySelect = document.getElementById('simDelivery'); // æ–°å¢ SIM å¡ Select
            
            const allFees = ["399", "599", "699", "799", "999", "1399"];

            // å®šç¾©æ‰€æœ‰ SIM å¡æ´¾é€é¸é … (å·²ç§»é™¤ã€Œé€å¡å€™è£œæ‹ç…§ã€)
            const allSimDeliveryOptions = [
                { value: "è¦ªé€", label: "è¦ªé€" },
                { value: "å¯„å¡", label: "å¯„å¡" },
                { value: "é€å¡", label: "é€å¡" },
                { value: "è‡³å…¬å¸å–å¡", label: "è‡³å…¬å¸å–å¡" },
                { value: "eSIM", label: "eSIM" },
                { value: "å°ä¸­å–å¡", label: "å°ä¸­å–å¡" },
            ];


            /**
             * æ ¹æ“šç”³è¾¦é›»ä¿¡æ›´æ–°æœˆè³‡è²»é¸é … (é å‚³ç§»é™¤ 699)ã€‚
             * @param {string} selectedProvider ç”³è¾¦é›»ä¿¡çš„å€¼ã€‚
             */
            function updateMonthlyFeeOptions(selectedProvider) {
                const currentFee = monthlyFeeSelect.value;
                monthlyFeeSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                let feesToShow = allFees;

                // é å‚³ç§»é™¤ 699
                if (selectedProvider === 'é å‚³') {
                    feesToShow = allFees.filter(fee => fee !== "699");
                }

                feesToShow.forEach(fee => {
                    const option = document.createElement('option');
                    option.value = fee;
                    option.textContent = fee;
                    monthlyFeeSelect.appendChild(option);
                });

                // å˜—è©¦é‚„åŸé¸ä¸­çš„å€¼
                if (feesToShow.includes(currentFee)) {
                    monthlyFeeSelect.value = currentFee;
                } else {
                    monthlyFeeSelect.value = ""; 
                }
            }
            
            /**
             * æ ¹æ“šç”³è¾¦é›»ä¿¡å‹•æ…‹æ›´æ–° SIM å¡æ´¾é€æ–¹å¼é¸é …ï¼Œå¯¦ç¾éæ¿¾éœ€æ±‚ã€‚
             * 1. ä¸­è¯ä¸è¦è¦ªé€ã€‚
             * 2. é å‚³ä¸è¦æœ‰è‡³å…¬å¸å–å¡ã€eSIMã€‚
             * @param {string} selectedProvider ç”³è¾¦é›»ä¿¡çš„å€¼ã€‚
             */
            function updateSimDeliveryOptions(selectedProvider) {
                const currentSimDelivery = simDeliverySelect.value;
                simDeliverySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                if (!selectedProvider) {
                    simDeliverySelect.value = "";
                    return;
                }

                let allowedOptions = allSimDeliveryOptions;

                if (selectedProvider === 'ä¸­è¯') {
                    // ä¸­è¯ä¸è¦è¦ªé€
                    allowedOptions = allowedOptions.filter(opt => opt.value !== "è¦ªé€");
                } else if (selectedProvider === 'é å‚³') {
                    // é å‚³ä¸è¦æœ‰è‡³å…¬å¸å–å¡ã€eSIM
                    allowedOptions = allowedOptions.filter(opt => opt.value !== "è‡³å…¬å¸å–å¡" && opt.value !== "eSIM");
                }

                allowedOptions.forEach(optionDef => {
                    const option = document.createElement('option');
                    option.value = optionDef.value;
                    option.textContent = optionDef.label;
                    simDeliverySelect.appendChild(option);
                });

                // å˜—è©¦é‚„åŸé¸ä¸­çš„å€¼ï¼Œå¦‚æœè¢«éæ¿¾æ‰å‰‡æ¸…ç©º
                if (allowedOptions.some(opt => opt.value === currentSimDelivery)) {
                    simDeliverySelect.value = currentSimDelivery;
                } else {
                    simDeliverySelect.value = "";
                }
            }


            /**
             * æ ¹æ“šç”³è¾¦é›»ä¿¡è‡ªå‹•è¨­å®šæ¬¾é …ã€‚
             * @param {string} selectedProvider ç”³è¾¦é›»ä¿¡çš„å€¼ã€‚
             */
            function autoSetPaymentType(selectedProvider) {
                if (selectedProvider === 'ä¸­è¯') {
                    paymentTypeSelect.value = 'é ç¹³é‡‘';
                } else if (selectedProvider === 'é å‚³') {
                    paymentTypeSelect.value = 'ç„¡';
                } else {
                    // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œæ¸…ç©ºæ¬¾é …
                    paymentTypeSelect.value = '';
                }
            }

            // å·¥é …é‚è¼¯å®šç¾© (Work Item Rules)
            const workItemRules = [
                // åŸºç¤å·¥é … 
                { name: "æ”¹æ–°è£æ©Ÿå·¥å–®", condition: (v) => v.jingnetStatus === "æ–°è£æ©Ÿæœªä»˜æ¬¾", category: "General" },
                { name: "æ›´æ–°å–å¡è¡¨", condition: (v) => v.telecomProvider === "ä¸­è¯" || v.telecomProvider === "é å‚³", category: "General" },
                { name: "é ç¹³é‡‘/åŒ¯æ¬¾è³‡æ–™æ ¸å°", condition: (v) => v.telecomProvider === "ä¸­è¯", category: "Finance" },
                { name: "ä¸­è¯ä¸ŠäºŒéš", condition: (v) => v.telecomProvider === "ä¸­è¯", category: "General" },
                { name: "é•ç´„å–®æ“šä¸Šå‚³ã€é€æœƒè¾¦", condition: (v) => v.originalContract === "é ˆè§£ç´„", category: "Contract" },
                { name: "ä¸»æ¥­æ¬Šè´ˆé€", condition: (v) => v.jingnetStatus.includes("æ–°è£æ©Ÿ") || v.jingnetStatus.includes("çºŒç´„å®¢"), category: "General" },
                
                // é€€è²»èˆ‡çµå–®
                { name: "é€€è²»(è«‹ç¢ºèªå®¢æˆ¶å·²ç¹³è²»ã€å·²è£æ©Ÿï¼Œé‡‘é¡è«‹è²¼è¨˜äº‹æœ¬)", condition: (v) => v.jingnetStatus === "æ–°è£æ©Ÿå·²ä»˜æ¬¾" || v.jingnetStatus === "çºŒç´„å®¢å·²ä»˜æ¬¾", category: "Refund" },
                { name: "Chatâ”€çµå–®(æœƒè¨ˆ)(è«‹å…ˆç¢ºèªå®¢æˆ¶å·²ç¹³è²»ã€å·²è£æ©Ÿ)", condition: (v) => v.jingnetStatus.includes("çºŒç´„å®¢") || v.jingnetStatus.includes("æœŸä¸­å®¢"), category: "Settlement" },
                
                // æ´¾é€èˆ‡ Chat é‚è¼¯
                
                // Chatâ”€å¯„é€ç¾¤: å¯„å¡, è¦ªé€, eSIM, OR (é å‚³ + å°ä¸­å–å¡)
                { 
                    name: "Chatâ”€å¯„é€ç¾¤", 
                    condition: (v) => ["å¯„å¡", "è¦ªé€", "eSIM"].includes(v.simDelivery) || 
                                     (v.telecomProvider === "é å‚³" && v.simDelivery === "å°ä¸­å–å¡"),
                    category: "Chat" 
                },
                
                // Chat--ä¸­è¯æ‹ç…§ç¾¤: ç”³è¾¦ä¸­è¯ (èˆ‡ SIM æ´¾é€æ–¹å¼ç„¡é—œ)
                { 
                    name: "Chat--ä¸­è¯æ‹ç…§ç¾¤", 
                    condition: (v) => v.telecomProvider === "ä¸­è¯", 
                    category: "Chat" 
                },
                
                // Chatâ”€å…¨å€åŠ©ç†: åªè¦æœ‰é¸ã€Œé€å¡ã€éƒ½è¦è§¸ç™¼ (å·²ç§»é™¤ã€Œé€å¡å€™è£œæ‹ç…§ã€)
                { 
                    name: "Chatâ”€å…¨å€åŠ©ç†", 
                    condition: (v) => v.simDelivery === "é€å¡",
                    category: "Chat" 
                },
                
                // æ´¾å¡ç¶²ç¶­å–®(ç„¡å·¥å–®) 
                { 
                    name: "æ´¾å¡ç¶²ç¶­å–®(ç„¡å·¥å–®)", 
                    condition: (v) => v.simDelivery === "é€å¡" && 
                                     v.jingnetStatus !== "æ–°è£æ©Ÿæœªä»˜æ¬¾" && 
                                     !(v.telecomProvider === "ä¸­è¯" && v.jingnetStatus === "æœŸä¸­å®¢"), 
                    category: "Dispatch" 
                },

                // é›»å•†æ´¾æ¡ˆ: SIMå¡æ´¾é€æ–¹å¼å…¨éƒ¨éƒ½è§¸ç™¼
                { name: "é›»å•†æ´¾æ¡ˆ", condition: (v) => v.simDelivery !== "", category: "Dispatch" }, 
            ];

            function calculateWorkItems() {
                // 1. å–å¾—æ‰€æœ‰è¼¸å…¥å€¼
                const values = {
                    planStatus: planStatusSelect.value, 
                    telecomProvider: telecomProviderSelect.value,
                    monthlyFee: monthlyFeeSelect.value,
                    internetMonths: internetMonthsSelect.value,

                    // Block 2 fields
                    jingnetStatus: document.getElementById('jingnetStatus').value,
                    originalContract: document.getElementById('originalContract').value,
                    paymentType: paymentTypeSelect.value, 
                    simDelivery: document.getElementById('simDelivery').value,
                    otherTaskDescription: document.getElementById('otherTaskDescription').value.trim(),
                };

                
                // === å€å¡Šä¸€è¼¸å‡ºé‚è¼¯ (Primary Output) ===
                // æª¢æŸ¥å€å¡Šä¸€æ‰€æœ‰æ¬„ä½æ˜¯å¦éƒ½æœ‰å€¼
                const primarySelected = values.planStatus !== "" && values.telecomProvider !== "" && values.monthlyFee !== "" && values.internetMonths !== "";
                
                // çµ„åˆè¼¸å‡ºæ ¼å¼: [æ–¹æ¡ˆç‹€æ…‹][ç”³è¾¦é›»ä¿¡][æœˆè³‡è²»]/[ç¶²è·¯æœˆä»½]
                const primaryOutputText = primarySelected 
                    ? `${values.planStatus}${values.telecomProvider}${values.monthlyFee}/${values.internetMonths}`
                    : '';

                if (primarySelected) {
                    primaryOutputDiv.innerHTML = `<span class="primary-output-text">${primaryOutputText}</span>`;
                    primaryOutputDiv.dataset.plainText = primaryOutputText;
                } else {
                    primaryOutputDiv.innerHTML = '<p class="text-gray-500 italic">è«‹åœ¨å·¦å´å¡«å¯«å€å¡Šä¸€è³‡è¨Š</p>';
                    primaryOutputDiv.dataset.plainText = '';
                }

                
                // === å€å¡ŠäºŒå·¥é …æ¸…å–®é‚è¼¯ (Secondary Output) ===
                
                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰**å¿…è¦**æ¬„ä½éƒ½æœ‰å€¼ (å·²åŒ…å« planStatus)
                const requiredFields = [
                    'planStatus', 'telecomProvider', 'monthlyFee', 'jingnetStatus', 
                    'originalContract', 'internetMonths', 'paymentType', 'simDelivery'
                ];

                const allSelectedForWorkItems = requiredFields.every(key => values[key] !== "");

                if (!allSelectedForWorkItems) {
                    workItemsOutputDiv.innerHTML = '<p class="text-gray-500 italic text-center pt-8">è«‹åœ¨å·¦å´**å®Œæ•´**å¡«å¯«æ‰€æœ‰å®¢æˆ¶è³‡è¨Šï¼Œå·¥é …æœƒå³æ™‚è‡ªå‹•ç”Ÿæˆã€‚</p>';
                    chunghwaMidTermWarning.classList.add('hidden');
                    workItemsOutputDiv.dataset.plainText = '';
                    return;
                }

                // 2. åˆ¤æ–·ç¬¦åˆçš„å·¥é …
                let requiredWorkItems = workItemRules
                    .filter(rule => rule.condition(values))
                    .map(rule => ({ name: rule.name, category: rule.category }));

                // 3. è™•ç†äº’æ–¥é‚è¼¯: çµå–® vs é€€è²»
                const hasRefund = requiredWorkItems.some(item => item.category === "Refund");
                if (hasRefund) {
                    requiredWorkItems = requiredWorkItems.filter(item => item.category !== "Settlement");
                }

                // 4. è™•ç†ã€Œå…¶ä»–å·¥é …(è«‹å¯«ä»»å‹™èªªæ˜)ã€
                if (values.otherTaskDescription) {
                    requiredWorkItems.push({ name: `å…¶ä»–(è«‹å¯«ä»»å‹™èªªæ˜): ${values.otherTaskDescription}`, category: "Other" });
                }

                // 5. è™•ç†ä¸­è¯ç´…å­—æé†’ (é‚è¼¯ï¼šåªè¦æ˜¯ä¸­è¯é›»ä¿¡å°±é¡¯ç¤º)
                const isChunghwa = values.telecomProvider === "ä¸­è¯";
                // ç”±æ–¼ã€Œé€å¡å€™è£œæ‹ç…§ã€å·²ç§»é™¤ï¼Œè­¦å‘Šèªå¯ä»¥æ›´ç‚ºé€šç”¨
                const warningMessage = 'âš ï¸ è‹¥å®¢æˆ¶ç„¡æ³•é…åˆæ™‚é–“è‡³å…¬å¸æ´¾ç…§å–å¡ï¼Œè«‹å¦æ´¾å¡ç¶²ç¶­å–®';
                
                if (isChunghwa) {
                    chunghwaMidTermWarning.innerHTML = warningMessage;
                    chunghwaMidTermWarning.classList.remove('hidden');
                } else {
                    chunghwaMidTermWarning.classList.add('hidden');
                }

                // 6. ç”¢ç”Ÿè¼¸å‡º HTML/Text
                const finalWorkItemNames = requiredWorkItems.map(item => item.name);

                if (finalWorkItemNames.length === 0) {
                     workItemsOutputDiv.innerHTML = '<p class="text-gray-500 italic text-center pt-8">ç›®å‰æƒ…å¢ƒä¸‹ç„¡ç‰¹æ®Šå·¥é …éœ€è¦è™•ç†ï¼Œè«‹æª¢æŸ¥è³‡è¨Šã€‚</p>';
                     workItemsOutputDiv.dataset.plainText = '';
                } else {
                    const listHtml = finalWorkItemNames.map(item => 
                        `<li class="flex items-start text-gray-800">
                            <span class="text-green-500 mr-2 mt-0.5 text-lg flex-shrink-0">âœ“</span>
                            <span class="font-medium">${item}</span>
                        </li>`
                    ).join('');
                    
                    workItemsOutputDiv.dataset.plainText = finalWorkItemNames.join('\n');
                    workItemsOutputDiv.innerHTML = `<ul class="space-y-3 list-none p-0 m-0">${listHtml}</ul>`;
                }
            }
            
            // --- Helper Functions ---
            function showConfirmation(message, styleClasses) {
                confirmationMessage.textContent = message;
                confirmationMessage.className = `mt-4 p-3 text-center rounded-lg font-medium shadow-md transition duration-300 ${styleClasses}`;
                confirmationMessage.classList.remove('hidden');
                setTimeout(() => {
                    confirmationMessage.classList.add('hidden');
                }, 3000);
            }
            
            function copyToClipboard(text, successMessage, failureMessage) {
                if (!text || text.trim() === '') {
                    showConfirmation('ç„¡æ³•è¤‡è£½ï¼Œè«‹å…ˆå¡«å¯«å®Œç•¢ï¼', 'bg-red-100 border-red-300 text-red-800');
                    return;
                }
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    showConfirmation(successMessage, 'bg-indigo-100 border-indigo-300 text-indigo-800');
                } catch (err) {
                    showConfirmation(failureMessage, 'bg-red-100 border-red-300 text-red-800');
                }
                document.body.removeChild(tempTextarea);
            }

            // --- Event Listeners ---
            
            // å³æ™‚æ›´æ–°
            form.addEventListener('change', calculateWorkItems);
            form.addEventListener('input', calculateWorkItems); 
            
            // ç›£è½ç”³è¾¦é›»ä¿¡çš„è®Šå‹•ï¼šæ›´æ–°æœˆè³‡è²»ã€è‡ªå‹•è¨­å®šæ¬¾é …ã€æ›´æ–° SIM æ´¾é€é¸é …
            telecomProviderSelect.addEventListener('change', (event) => {
                const selectedProvider = event.target.value;
                updateMonthlyFeeOptions(selectedProvider);
                autoSetPaymentType(selectedProvider); 
                updateSimDeliveryOptions(selectedProvider); // æ ¹æ“šé›»ä¿¡å•†ç¯©é¸ SIM å¡é¸é …
                calculateWorkItems();
            });

            // è¤‡è£½æŒ‰éˆ•åŠŸèƒ½ (å€å¡Šä¸€ï¼šæ–¹æ¡ˆé€Ÿè¨˜)
            copyPrimaryButton.addEventListener('click', () => {
                const plainText = primaryOutputDiv.dataset.plainText;
                copyToClipboard(
                    plainText, 
                    'æ–¹æ¡ˆé€Ÿè¨˜å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 
                    'è¤‡è£½æ–¹æ¡ˆé€Ÿè¨˜å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'
                );
            });
            
            // è¤‡è£½æŒ‰éˆ•åŠŸèƒ½ (å€å¡ŠäºŒï¼šå·¥é …æ¸…å–®)
            copyWorkItemsButton.addEventListener('click', () => {
                const plainText = workItemsOutputDiv.dataset.plainText;
                copyToClipboard(
                    plainText, 
                    'å·¥é …æ¸…å–®å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 
                    'è¤‡è£½å·¥é …æ¸…å–®å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'
                );
            });


            // åˆå§‹åŒ–æ™‚ï¼šè¨­å®šæœˆè³‡è²»é¸é …ã€SIM æ´¾é€é¸é …ï¼Œå†è¨ˆç®—å·¥é …
            updateMonthlyFeeOptions(telecomProviderSelect.value);
            updateSimDeliveryOptions(telecomProviderSelect.value);
            calculateWorkItems();
        });
    </script>
</body>
</html>
