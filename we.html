<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無敵團隊公告系統</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --tiffany-green: #0ABAB5;
            --star-gold: #FFD700;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F4FAFA;
            margin: 0;
            padding: 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #0ABAB5;
            border-radius: 10px;
        }

        /* 星星交互隔離 */
        .ann-card-container {
            position: relative;
            isolation: isolate;
        }

        .star-clickable-area {
            position: absolute !important;
            top: 1rem !important;
            right: 1rem !important;
            width: 44px !important;
            height: 44px !important;
            z-index: 100 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            background: transparent;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .star-clickable-area:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .star-active {
            filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
        }

        .ann-card-main {
            position: relative;
            z-index: 1;
        }

        .pdf-preview {
            width: 100%;
            height: 400px;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const STAFF_LIST = [
            { id: 1, dept: '電銷部', title: '經理', name: '郭雅玲' },
            { id: 2, dept: '電銷部', title: '培訓師', name: '嚴婕瑜' },
            { id: 3, dept: '電銷部', title: '管理師', name: '沈姵妤' },
            { id: 4, dept: '電銷部', title: '業助', name: '吳宜庭' },
            { id: 5, dept: '電銷部', title: '業務', name: '李家榛' },
            { id: 6, dept: '電銷部', title: '業務', name: '黃鈞霖' },
            { id: 7, dept: '電銷部', title: '業務', name: '蕭茜文' },
            { id: 8, dept: '電銷部', title: '業務', name: '葉潭' },
            { id: 10, dept: '電銷部', title: '業務', name: '楊曉念' },
            { id: 11, dept: '電銷部', title: '業務', name: '張妤甄' },
            { id: 13, dept: '電銷部', title: '業務', name: '吳昀庭' },
        ];

        const App = () => {
            const [currentUserId, setCurrentUserId] = useState(() => {
                const saved = localStorage.getItem('invincible_user_id');
                return saved ? parseInt(saved) : null;
            });
            const [favorites, setFavorites] = useState(() => {
                const saved = localStorage.getItem('invincible_favorites');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [announcements, setAnnouncements] = useState([
                {
                    id: 'ann-001',
                    authorId: 1,
                    title: '電銷話務流程標準化調整',
                    content: '請各位夥伴注意，自明日起進線標籤需統一標記「A級意向」。',
                    createdAt: new Date().toISOString().split('T')[0],
                    priority: 'high',
                    targetStaffIds: STAFF_LIST.map(s => s.id),
                    readBy: [1, 2],
                    attachments: []
                }
            ]);

            const [activeTab, setActiveTab] = useState('lobby');
            const [selectedAnn, setSelectedAnn] = useState(null);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showFilteredList, setShowFilteredList] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentMonth, setCurrentMonth] = useState(new Date());

            // 發佈表單狀態
            const [newTitle, setNewTitle] = useState('');
            const [newContent, setNewContent] = useState('');
            const [newPriority, setNewPriority] = useState('normal');
            const [newFiles, setNewFiles] = useState([]);
            const [newTargetIds, setNewTargetIds] = useState(STAFF_LIST.map(s => s.id));

            useEffect(() => {
                if (currentUserId) localStorage.setItem('invincible_user_id', currentUserId);
            }, [currentUserId]);

            useEffect(() => {
                localStorage.setItem('invincible_favorites', JSON.stringify(favorites));
            }, [favorites]);

            useEffect(() => { lucide.createIcons(); }, [activeTab, selectedAnn, showLoginModal, currentUserId, favorites, showFilteredList, showCreateModal, newTargetIds]);

            const currentUser = STAFF_LIST.find(s => s.id === currentUserId);

            const stats = useMemo(() => {
                const allUnread = announcements.filter(ann => ann.readBy.length < ann.targetStaffIds.length);
                const myUnread = currentUserId ? announcements.filter(ann => ann.targetStaffIds.includes(currentUserId) && !ann.readBy.includes(currentUserId)) : [];
                return { allUnread, myUnread };
            }, [announcements, currentUserId]);

            const toggleFavorite = (e, annId) => {
                e.preventDefault();
                e.stopPropagation(); 
                setFavorites(prev => 
                    prev.includes(annId) ? prev.filter(id => id !== annId) : [...prev, annId]
                );
            };

            const handleLogin = (id) => {
                setCurrentUserId(id);
                setShowLoginModal(false);
            };

            const handleMarkAsRead = (annId) => {
                if (!currentUserId) return;
                setAnnouncements(prev => prev.map(ann => {
                    if (ann.id === annId && !ann.readBy.includes(currentUserId)) {
                        return { ...ann, readBy: [...ann.readBy, currentUserId] };
                    }
                    return ann;
                }));
                setSelectedAnn(null);
            };

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setNewFiles(prev => [...prev, {
                            name: file.name,
                            type: file.type,
                            data: event.target.result
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const toggleTargetId = (id) => {
                setNewTargetIds(prev => 
                    prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id]
                );
            };

            const handleSelectAllTargets = () => {
                if (newTargetIds.length === STAFF_LIST.length) {
                    setNewTargetIds([]);
                } else {
                    setNewTargetIds(STAFF_LIST.map(s => s.id));
                }
            };

            const handleCreateAnnouncement = () => {
                if (!newTitle || !newContent || newTargetIds.length === 0) return;
                const newAnn = {
                    id: `ann-${Date.now()}`,
                    authorId: currentUserId || 1,
                    title: newTitle,
                    content: newContent,
                    createdAt: selectedDate,
                    priority: newPriority,
                    targetStaffIds: newTargetIds,
                    readBy: [],
                    attachments: newFiles
                };
                setAnnouncements([newAnn, ...announcements]);
                setShowCreateModal(false);
                setNewTitle('');
                setNewContent('');
                setNewPriority('normal');
                setNewFiles([]);
                setNewTargetIds(STAFF_LIST.map(s => s.id));
            };

            const dailyAnnouncements = useMemo(() => {
                let list = announcements.filter(ann => ann.createdAt === selectedDate);
                if (searchQuery) {
                    list = list.filter(ann => ann.title.includes(searchQuery) || ann.content.includes(searchQuery));
                }
                return list;
            }, [announcements, selectedDate, searchQuery]);

            const renderCalendar = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const totalDays = new Date(year, month + 1, 0).getDate();
                const startDay = new Date(year, month, 1).getDay();
                const days = [];
                for (let i = 0; i < startDay; i++) days.push(<div key={`empty-${i}`} className="h-14 border-t border-r border-slate-100 bg-slate-50/50"></div>);
                for (let d = 1; d <= totalDays; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const count = announcements.filter(ann => ann.createdAt === dateStr).length;
                    const isSelected = selectedDate === dateStr;
                    days.push(
                        <div key={d} onClick={() => setSelectedDate(dateStr)} className={`h-14 border-t border-r border-slate-100 p-1 cursor-pointer relative transition-colors ${isSelected ? 'bg-[#e6f7f7] ring-1 ring-[#0ABAB5] z-10' : 'bg-white hover:bg-slate-50'}`}>
                            <span className={`text-xs font-bold ${isSelected ? 'text-[#0ABAB5]' : 'text-slate-400'}`}>{d}</span>
                            {count > 0 && (
                                <div className="absolute bottom-1 right-1 bg-[#0ABAB5] text-white text-[9px] font-black w-4 h-4 rounded-full flex items-center justify-center shadow-sm">
                                    {count}
                                </div>
                            )}
                        </div>
                    );
                }
                return days;
            };

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
                        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="bg-[#0ABAB5] p-1.5 rounded-lg text-white"><Icon name="shield-check" /></div>
                                <h1 className="text-xl font-black text-slate-800">無敵團隊<span className="text-[#0ABAB5]">公告</span></h1>
                            </div>
                            <div>
                                {currentUser ? (
                                    <div className="flex items-center space-x-3 cursor-pointer" onClick={() => setShowLoginModal(true)}>
                                        <div className="text-right hidden sm:block leading-none">
                                            <p className="text-[10px] text-slate-400 font-bold mb-1 uppercase">{currentUser.dept}</p>
                                            <p className="text-sm font-black text-slate-700">{currentUser.name}</p>
                                        </div>
                                        <div className="w-10 h-10 rounded-full bg-[#e6f7f7] flex items-center justify-center text-[#0ABAB5] font-black border border-[#0ABAB5]/20 shadow-sm">
                                            {currentUser.name.slice(-2)}
                                        </div>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowLoginModal(true)} className="px-5 py-2 bg-[#0ABAB5] text-white rounded-xl text-sm font-black shadow-lg hover:bg-[#08928e] transition-all">登入系統</button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-6 space-y-6">
                        {/* 儀表板統計 */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div onClick={() => setShowFilteredList('all_unread')} className="stat-card bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between cursor-pointer group hover:border-[#0ABAB5]">
                                <div className="flex items-center space-x-4">
                                    <div className="bg-amber-100 p-3 rounded-xl text-amber-600 group-hover:bg-amber-200 transition-colors"><Icon name="users" /></div>
                                    <div>
                                        <p className="text-xs font-bold text-slate-400 mb-0.5">尚未全員讀取的公告</p>
                                        <p className="text-xl font-black text-slate-700">共有 <span className="text-amber-600">{stats.allUnread.length}</span> 則</p>
                                    </div>
                                </div>
                                <Icon name="chevron-right" className="text-slate-300 group-hover:text-[#0ABAB5]" />
                            </div>
                            <div onClick={() => setShowFilteredList('my_unread')} className="stat-card bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between cursor-pointer group hover:border-[#0ABAB5]">
                                <div className="flex items-center space-x-4">
                                    <div className="bg-[#e6f7f7] p-3 rounded-xl text-[#0ABAB5] group-hover:bg-[#0ABAB5] group-hover:text-white transition-all"><Icon name="bell" /></div>
                                    <div>
                                        <p className="text-xs font-bold text-slate-400 mb-0.5">個人尚未讀取的公告</p>
                                        <p className="text-xl font-black text-slate-700">共有 <span className="text-[#0ABAB5]">{stats.myUnread.length}</span> 則</p>
                                    </div>
                                </div>
                                <Icon name="chevron-right" className="text-slate-300 group-hover:text-[#0ABAB5]" />
                            </div>
                        </div>

                        {/* 操作區域 */}
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex bg-slate-200/50 p-1 rounded-xl w-fit">
                                <button onClick={() => setActiveTab('lobby')} className={`px-6 py-2 rounded-lg text-sm font-black transition-all ${activeTab === 'lobby' ? 'bg-white shadow text-[#0ABAB5]' : 'text-slate-500'}`}>公告首頁</button>
                                <button onClick={() => setActiveTab('my')} className={`px-6 py-2 rounded-lg text-sm font-black transition-all ${activeTab === 'my' ? 'bg-white shadow text-[#0ABAB5]' : 'text-slate-500'}`}>我的收藏 ({favorites.length})</button>
                            </div>
                            <div className="flex items-center space-x-2 w-full md:w-auto">
                                <div className="relative flex-1">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icon name="search" className="w-4 h-4" /></span>
                                    <input type="text" placeholder="搜尋標題或內容..." className="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm w-full md:w-64 outline-none focus:ring-2 ring-[#0ABAB5]/20" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                </div>
                                <button onClick={() => setShowCreateModal(true)} className="p-2.5 bg-[#0ABAB5] text-white rounded-xl shadow-md hover:bg-[#08928e]"><Icon name="plus" /></button>
                            </div>
                        </div>

                        {activeTab === 'lobby' ? (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                <div className="lg:col-span-8 space-y-4">
                                    <h2 className="text-lg font-black text-slate-800 flex items-center mb-4">
                                        <span className="w-1.5 h-6 bg-[#0ABAB5] rounded-full mr-3"></span>
                                        {selectedDate} 公告事項
                                    </h2>
                                    {dailyAnnouncements.length > 0 ? dailyAnnouncements.map(ann => (
                                        <div key={ann.id} className="ann-card-container group">
                                            <div className="star-clickable-area" onClick={(e) => toggleFavorite(e, ann.id)}>
                                                <Icon name="star" className={`w-6 h-6 transition-all ${favorites.includes(ann.id) ? 'fill-[#FFD700] text-[#FFD700] star-active scale-110' : 'text-slate-200 hover:text-slate-300'}`} />
                                            </div>
                                            <div className="ann-card-main bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm hover:shadow-xl hover:border-[#0ABAB5]/30 transition-all cursor-pointer" onClick={() => setSelectedAnn(ann)}>
                                                <div className="flex items-center space-x-2 mb-3 pr-10">
                                                    {ann.priority === 'high' && <span className="px-2 py-0.5 bg-red-500 text-white text-[10px] font-black rounded-full">重要</span>}
                                                    {ann.attachments?.length > 0 && <span className="text-slate-300 flex items-center"><Icon name="paperclip" className="w-3 h-3" /></span>}
                                                    <span className="text-[10px] text-slate-400 font-bold tracking-wider">{STAFF_LIST.find(s => s.id === ann.authorId)?.name} 發佈</span>
                                                </div>
                                                <h3 className="text-xl font-black text-slate-800 mb-2 group-hover:text-[#0ABAB5] transition-colors pr-8">{ann.title}</h3>
                                                <p className="text-sm text-slate-400 line-clamp-2 leading-relaxed">{ann.content}</p>
                                                <div className="mt-5 pt-4 border-t border-slate-50 flex items-center justify-between">
                                                    <span className="text-[10px] font-bold text-slate-300">已讀：{ann.readBy.length}/{ann.targetStaffIds.length}</span>
                                                    <span className="text-[10px] font-black text-[#0ABAB5] italic">查看詳情 →</span>
                                                </div>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="py-20 bg-white border border-dashed rounded-[3rem] text-center text-slate-300 font-bold italic">當日尚無公告內容</div>
                                    )}
                                </div>

                                <div className="lg:col-span-4">
                                    <div className="bg-white rounded-[2rem] border border-slate-200 overflow-hidden sticky top-24 shadow-sm">
                                        <div className="p-4 bg-slate-50/50 border-b flex items-center justify-between">
                                            <span className="font-black text-slate-700 text-sm">{currentMonth.getFullYear()}年 {currentMonth.getMonth()+1}月</span>
                                            <div className="flex space-x-1">
                                                <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))} className="p-1.5 hover:bg-white rounded-lg transition-colors"><Icon name="chevron-left" className="w-4 h-4" /></button>
                                                <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))} className="p-1.5 hover:bg-white rounded-lg transition-colors"><Icon name="chevron-right" className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                        <div className="calendar-grid">
                                            {['日','一','二','三','四','五','六'].map(w => <div key={w} className="py-2 text-center text-[10px] font-black text-slate-300 uppercase">{w}</div>)}
                                            {renderCalendar()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {announcements.filter(ann => favorites.includes(ann.id)).map(ann => (
                                    <div key={ann.id} className="ann-card-container group">
                                        <div className="star-clickable-area" onClick={(e) => toggleFavorite(e, ann.id)}>
                                            <Icon name="star" className="w-6 h-6 fill-[#FFD700] text-[#FFD700] star-active" />
                                        </div>
                                        <div className="ann-card-main bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm hover:shadow-xl transition-all cursor-pointer" onClick={() => setSelectedAnn(ann)}>
                                            <span className="text-[10px] text-slate-400 font-bold">{ann.createdAt}</span>
                                            <h4 className="text-lg font-black text-slate-800 mb-2 mt-2 group-hover:text-[#0ABAB5] pr-8">{ann.title}</h4>
                                            <p className="text-xs text-slate-400 line-clamp-2">{ann.content}</p>
                                        </div>
                                    </div>
                                ))}
                                {favorites.length === 0 && (
                                    <div className="col-span-full py-20 text-center text-slate-300 font-bold italic bg-white/50 border border-dashed rounded-[3rem]">目前沒有收藏的公告</div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* 公告詳情彈窗 */}
                    {selectedAnn && (
                        <div className="fixed inset-0 z-[210] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
                            <div className="bg-white w-full max-w-3xl rounded-[3rem] p-8 md:p-10 relative shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                                <button onClick={() => setSelectedAnn(null)} className="absolute top-8 right-8 text-slate-300 hover:text-slate-500 bg-slate-50 p-2 rounded-full"><Icon name="x" /></button>
                                
                                <div className="mb-6">
                                    <div className="flex items-center space-x-2 mb-3">
                                        <span className={`px-2.5 py-1 text-[10px] font-black rounded-full ${selectedAnn.priority === 'high' ? 'bg-red-50 text-red-500' : 'bg-[#e6f7f7] text-[#0ABAB5]'}`}>
                                            {selectedAnn.priority === 'high' ? '重要' : '一般'}
                                        </span>
                                        <span className="text-[10px] text-slate-400 font-bold tracking-widest">{selectedAnn.createdAt}</span>
                                    </div>
                                    <h2 className="text-3xl font-black text-slate-800 leading-tight mb-4">{selectedAnn.title}</h2>
                                    <div className="bg-slate-50 p-6 md:p-8 rounded-[2rem] text-slate-600 leading-relaxed border border-slate-100/50 mb-6 whitespace-pre-wrap text-base">
                                        {selectedAnn.content}
                                    </div>

                                    {/* 附件展示 */}
                                    {selectedAnn.attachments && selectedAnn.attachments.length > 0 && (
                                        <div className="space-y-6 mb-8">
                                            <h4 className="text-sm font-black text-slate-700 border-l-4 border-[#0ABAB5] pl-3">附件內容</h4>
                                            {selectedAnn.attachments.map((file, idx) => (
                                                <div key={idx} className="bg-white border border-slate-100 rounded-2xl p-4">
                                                    <p className="text-xs font-bold text-slate-400 mb-3 flex items-center"><Icon name="file" className="w-3 h-3 mr-1" /> {file.name}</p>
                                                    {file.type.includes('image') ? (
                                                        <img src={file.data} className="image-preview mx-auto" alt="attachment" />
                                                    ) : file.type === 'application/pdf' ? (
                                                        <iframe src={file.data} className="pdf-preview" title="pdf-viewer"></iframe>
                                                    ) : (
                                                        <a href={file.data} download={file.name} className="flex items-center p-4 bg-slate-50 rounded-xl text-[#0ABAB5] font-bold text-sm">
                                                            <Icon name="download" className="mr-2" /> 下載檔案
                                                        </a>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <h5 className="text-[10px] font-black text-[#0ABAB5] mb-3 uppercase tracking-widest flex items-center">
                                            <Icon name="check-circle-2" className="w-3 h-3 mr-1.5" /> 已讀人員 ({selectedAnn.readBy.length})
                                        </h5>
                                        <div className="flex flex-wrap gap-2">
                                            {selectedAnn.readBy.length > 0 ? selectedAnn.readBy.map(uid => (
                                                <span key={uid} className="px-3 py-1 bg-emerald-50 text-emerald-600 text-[11px] font-bold rounded-full">
                                                    {STAFF_LIST.find(s => s.id === uid)?.name}
                                                </span>
                                            )) : <span className="text-xs text-slate-300 italic">尚無人讀取</span>}
                                        </div>
                                    </div>
                                    <div>
                                        <h5 className="text-[10px] font-black text-red-400 mb-3 uppercase tracking-widest flex items-center">
                                            <Icon name="alert-circle" className="w-3 h-3 mr-1.5" /> 未讀人員 ({selectedAnn.targetStaffIds.length - selectedAnn.readBy.length})
                                        </h5>
                                        <div className="flex flex-wrap gap-2">
                                            {selectedAnn.targetStaffIds.filter(id => !selectedAnn.readBy.includes(id)).map(uid => (
                                                <span key={uid} className="px-3 py-1 bg-red-50 text-red-400 text-[11px] font-bold rounded-full">
                                                    {STAFF_LIST.find(s => s.id === uid)?.name}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {currentUserId && !selectedAnn.readBy.includes(currentUserId) && selectedAnn.targetStaffIds.includes(currentUserId) ? (
                                    <button onClick={() => handleMarkAsRead(selectedAnn.id)} className="w-full bg-[#0ABAB5] text-white font-black py-5 rounded-2xl shadow-lg hover:bg-[#08928e] flex items-center justify-center space-x-2">
                                        <Icon name="check-square" /> <span>我已閱畢此公告</span>
                                    </button>
                                ) : (
                                    <button onClick={() => setSelectedAnn(null)} className="w-full bg-slate-100 text-slate-400 font-black py-5 rounded-2xl">關閉視窗</button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* 發佈新公告彈窗：新增必讀人員選取 */}
                    {showCreateModal && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-xl rounded-[2.5rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                                <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center"><Icon name="plus-circle" className="mr-3 text-[#0ABAB5]" /> 發佈新公告</h2>
                                
                                <div className="space-y-6">
                                    {/* 公告等級 */}
                                    <div className="space-y-2">
                                        <label className="text-xs font-black text-slate-400 uppercase tracking-widest">公告等級</label>
                                        <div className="flex bg-slate-100 p-1 rounded-xl">
                                            <button onClick={() => setNewPriority('normal')} className={`flex-1 py-2 rounded-lg text-sm font-black transition-all ${newPriority === 'normal' ? 'bg-white text-[#0ABAB5] shadow-sm' : 'text-slate-400'}`}>一般公告</button>
                                            <button onClick={() => setNewPriority('high')} className={`flex-1 py-2 rounded-lg text-sm font-black transition-all ${newPriority === 'high' ? 'bg-red-500 text-white shadow-md' : 'text-slate-400'}`}>重要公告</button>
                                        </div>
                                    </div>

                                    {/* 必讀人員選取區 */}
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-end">
                                            <label className="text-xs font-black text-slate-400 uppercase tracking-widest">設定必讀人員 ({newTargetIds.length}/{STAFF_LIST.length})</label>
                                            <button onClick={handleSelectAllTargets} className="text-[10px] font-black text-[#0ABAB5] hover:underline underline-offset-2">
                                                {newTargetIds.length === STAFF_LIST.length ? '全部取消' : '全部選取'}
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-3 sm:grid-cols-4 gap-2 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                            {STAFF_LIST.map(staff => (
                                                <button key={staff.id} onClick={() => toggleTargetId(staff.id)} className={`py-2 px-1 rounded-xl text-[11px] font-bold transition-all border ${newTargetIds.includes(staff.id) ? 'bg-[#0ABAB5] text-white border-[#0ABAB5] shadow-sm' : 'bg-white text-slate-400 border-slate-100 hover:border-[#0ABAB5]/30'}`}>
                                                    {staff.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-black text-slate-400 uppercase tracking-widest">標題</label>
                                        <input type="text" placeholder="輸入公告標題..." className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold text-slate-700 mt-2 focus:ring-2 ring-[#0ABAB5]/10" value={newTitle} onChange={e => setNewTitle(e.target.value)} />
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-black text-slate-400 uppercase tracking-widest">內容</label>
                                        <textarea rows="3" placeholder="輸入詳細內容..." className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none text-sm text-slate-600 mt-2 focus:ring-2 ring-[#0ABAB5]/10" value={newContent} onChange={e => setNewContent(e.target.value)}></textarea>
                                    </div>

                                    {/* 檔案上傳 */}
                                    <div>
                                        <label className="text-xs font-black text-slate-400 uppercase tracking-widest">附件 (圖片或 PDF)</label>
                                        <div className="mt-2 space-y-3">
                                            <label className="block cursor-pointer bg-white border-2 border-dashed border-slate-200 p-4 rounded-2xl text-center hover:border-[#0ABAB5] transition-colors group">
                                                <input type="file" multiple accept="image/*,application/pdf" className="hidden" onChange={handleFileUpload} />
                                                <Icon name="upload" className="mx-auto mb-1 text-slate-300 group-hover:text-[#0ABAB5]" />
                                                <span className="text-[10px] font-black text-slate-400">點擊上傳檔案</span>
                                            </label>
                                            {newFiles.length > 0 && (
                                                <div className="grid grid-cols-2 gap-2">
                                                    {newFiles.map((f, i) => (
                                                        <div key={i} className="flex items-center justify-between p-2 bg-[#e6f7f7] rounded-lg border border-[#0ABAB5]/10">
                                                            <span className="text-[10px] font-bold text-[#0ABAB5] truncate max-w-[80%]">{f.name}</span>
                                                            <button onClick={() => setNewFiles(newFiles.filter((_, idx) => idx !== i))}><Icon name="x" className="w-3 h-3 text-red-400" /></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex space-x-3 mt-8 pt-6 border-t border-slate-50">
                                    <button onClick={() => { setShowCreateModal(false); setNewFiles([]); }} className="flex-1 py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold">取消</button>
                                    <button onClick={handleCreateAnnouncement} className={`flex-1 py-4 rounded-2xl font-black shadow-lg transition-all ${newTitle && newContent && newTargetIds.length > 0 ? 'bg-[#0ABAB5] text-white hover:bg-[#08928e]' : 'bg-slate-100 text-slate-300 cursor-not-allowed'}`}>確認發佈</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 篩選清單彈窗 */}
                    {showFilteredList && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl">
                                <div className="p-5 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="font-black text-slate-700">{showFilteredList === 'all_unread' ? '尚未全員讀取的公告' : '個人待讀公告'}</h3>
                                    <button onClick={() => setShowFilteredList(null)} className="text-slate-400 hover:text-slate-600 p-2"><Icon name="x" /></button>
                                </div>
                                <div className="p-4 max-h-[400px] overflow-y-auto custom-scrollbar space-y-2">
                                    {(showFilteredList === 'all_unread' ? stats.allUnread : stats.myUnread).map(ann => (
                                        <div key={ann.id} onClick={() => { setSelectedAnn(ann); setShowFilteredList(null); }} className="p-4 border border-slate-100 rounded-2xl hover:bg-[#e6f7f7] hover:border-[#0ABAB5]/20 cursor-pointer group transition-all">
                                            <div className="flex justify-between items-start">
                                                <p className="text-sm font-black text-slate-800 group-hover:text-[#0ABAB5]">{ann.title}</p>
                                                <span className="text-[10px] text-slate-400 font-bold whitespace-nowrap ml-4">{ann.createdAt}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {(showFilteredList === 'all_unread' ? stats.allUnread : stats.myUnread).length === 0 && (
                                        <div className="text-center py-10 text-slate-300 font-bold italic">目前沒有相關公告</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 登入彈窗 */}
                    {showLoginModal && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl text-center">
                                <div className="w-20 h-20 bg-[#e6f7f7] text-[#0ABAB5] rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-xl"><Icon name="user-check" className="w-10 h-10" /></div>
                                <h2 className="text-2xl font-black text-slate-800 mb-6 tracking-tight">切換登入身份</h2>
                                <div className="grid grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                                    {STAFF_LIST.map(staff => (
                                        <button key={staff.id} onClick={() => handleLogin(staff.id)} className={`p-4 rounded-2xl border transition-all text-left ${currentUserId === staff.id ? 'border-[#0ABAB5] bg-[#e6f7f7] ring-2 ring-[#0ABAB5]/10' : 'border-slate-50 bg-slate-50 hover:bg-white hover:border-[#0ABAB5]/40 hover:shadow-md'}`}>
                                            <div className="text-sm font-black text-slate-700">{staff.name}</div>
                                            <div className="text-[9px] text-slate-400 font-bold uppercase">{staff.title}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
