import React, { useState, useMemo } from 'react';
import { 
  Bell, 
  CheckCircle, 
  AlertCircle, 
  Users, 
  ChevronRight, 
  ClipboardCheck,
  LayoutDashboard,
  Megaphone,
  PlusCircle,
  X,
  Send,
  UserCheck,
  Clock
} from 'lucide-react';

// 部門成員清單
const STAFF_LIST = [
  { id: 1, dept: '電銷部', title: '經理', name: '郭雅玲', nickname: 'Vivian' },
  { id: 2, dept: '電銷部', title: '培訓師', name: '嚴婕瑜', nickname: '小艾' },
  { id: 3, dept: '電銷部', title: '管理師', name: '沈姵妤', nickname: '' },
  { id: 4, dept: '電銷部', title: '業助', name: '吳宜庭', nickname: '' },
  { id: 5, dept: '電銷部', title: '業務', name: '李家榛', nickname: '' },
  { id: 6, dept: '電銷部', title: '業務', name: '黃鈞霖', nickname: '' },
  { id: 7, dept: '電銷部', title: '業務', name: '蕭茜文', nickname: '' },
  { id: 8, dept: '電銷部', title: '業務', name: '葉潭', nickname: '小葉' },
  { id: 9, dept: '電銷部', title: '業務', name: '陳鐿瑄', nickname: '' },
  { id: 10, dept: '電銷部', title: '業務', name: '楊曉念', nickname: '' },
  { id: 11, dept: '電銷部', title: '業務', name: '張妤甄', nickname: '' },
  { id: 12, dept: '電銷部', title: '業務', name: '卓于琬', nickname: '' },
  { id: 13, dept: '電銷部', title: '業務', name: '吳昀庭', nickname: '' },
];

const TIFFANY_GREEN = "#81D8D0";

const App = () => {
  const [announcements, setAnnouncements] = useState([
    {
      id: 'ann-001',
      authorId: 1,
      title: '電銷話務流程標準化調整',
      content: '請各位夥伴注意，自明日起進線標籤需統一標記「A級意向」。',
      createdAt: '2024-05-20 09:00',
      priority: 'high',
      targetStaffIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13], // 全員
      readBy: [1, 2, 13]
    }
  ]);

  const [currentUserId, setCurrentUserId] = useState(1);
  const [activeTab, setActiveTab] = useState('lobby'); // 'lobby' | 'my'
  const [selectedAnn, setSelectedAnn] = useState(null);
  const [showCreateModal, setShowCreateModal] = useState(false);

  // 新公告表單狀態
  const [newAnn, setNewAnn] = useState({
    title: '',
    content: '',
    priority: 'normal',
    targetStaffIds: STAFF_LIST.map(s => s.id) // 預設全員
  });

  const formatName = (fullName) => fullName.length > 2 ? fullName.substring(fullName.length - 2) : fullName;

  // 儀表板數據：篩選「我發佈的」或「我要負責監督的」未完成公告
  const incompleteAnnouncements = useMemo(() => {
    return announcements.filter(ann => ann.readBy.length < ann.targetStaffIds.length);
  }, [announcements]);

  // 我的公告：我是接收對象之一
  const myRelevantAnnouncements = useMemo(() => {
    return announcements.filter(ann => ann.targetStaffIds.includes(currentUserId));
  }, [announcements, currentUserId]);

  const handleConfirmRead = (annId) => {
    setAnnouncements(prev => prev.map(ann => {
      if (ann.id === annId && !ann.readBy.includes(currentUserId)) {
        return { ...ann, readBy: [...ann.readBy, currentUserId] };
      }
      return ann;
    }));
    setSelectedAnn(null);
  };

  const handleCreateAnnouncement = () => {
    if (!newAnn.title || !newAnn.content) return;
    const newEntry = {
      ...newAnn,
      id: `ann-${Date.now()}`,
      authorId: currentUserId,
      createdAt: new Date().toLocaleString(),
      readBy: [currentUserId] // 作者自動已讀
    };
    setAnnouncements([newEntry, ...announcements]);
    setShowCreateModal(false);
    setNewAnn({ title: '', content: '', priority: 'normal', targetStaffIds: STAFF_LIST.map(s => s.id) });
  };

  const toggleTargetStaff = (staffId) => {
    setNewAnn(prev => ({
      ...prev,
      targetStaffIds: prev.targetStaffIds.includes(staffId)
        ? prev.targetStaffIds.filter(id => id !== staffId)
        : [...prev.targetStaffIds, staffId]
    }));
  };

  return (
    <div className="min-h-screen bg-[#F7FBFA] font-sans text-slate-800">
      {/* 頂部導航 */}
      <header className="bg-white border-b border-[#E0F2F0] sticky top-0 z-40 shadow-sm">
        <div className="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="bg-[#81D8D0] p-2.5 rounded-2xl shadow-sm">
              <Megaphone className="text-white w-6 h-6" />
            </div>
            <div>
              <h1 className="text-2xl font-black tracking-tight text-[#4A8F88]">智生活公告專區</h1>
              <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Smart Life Announcement</p>
            </div>
          </div>
          
          <div className="flex items-center space-x-6">
            <button 
              onClick={() => setShowCreateModal(true)}
              className="hidden md:flex items-center px-4 py-2.5 bg-[#81D8D0] hover:bg-[#6ec9c1] text-white rounded-xl font-bold transition-all shadow-md shadow-[#81d8d044] active:scale-95"
            >
              <PlusCircle className="w-5 h-5 mr-2" />
              發佈新公告
            </button>
            <div className="h-10 w-px bg-slate-100 mx-2"></div>
            <div className="flex items-center text-right">
              <div className="mr-3 hidden sm:block">
                <p className="text-xs text-slate-400 font-medium">{STAFF_LIST.find(s => s.id === currentUserId).dept}</p>
                <p className="text-sm font-bold text-slate-700">{STAFF_LIST.find(s => s.id === currentUserId).name}</p>
              </div>
              <div className="w-12 h-12 rounded-2xl bg-[#E0F2F0] flex items-center justify-center text-[#4A8F88] font-black border-2 border-white shadow-sm overflow-hidden">
                {formatName(STAFF_LIST.find(s => s.id === currentUserId).name)}
              </div>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 space-y-8">
        
        {/* 切換區域 */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div className="flex space-x-2 bg-[#E0F2F0]/50 p-1.5 rounded-2xl w-fit border border-white">
            <button 
              onClick={() => setActiveTab('lobby')}
              className={`flex items-center px-6 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab === 'lobby' ? 'bg-white shadow-md text-[#4A8F88]' : 'text-slate-500 hover:bg-white/50'}`}
            >
              <LayoutDashboard className="w-4 h-4 mr-2" />
              數據大廳
            </button>
            <button 
              onClick={() => setActiveTab('my')}
              className={`flex items-center px-6 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab === 'my' ? 'bg-white shadow-md text-[#4A8F88]' : 'text-slate-500 hover:bg-white/50'}`}
            >
              <Bell className="w-4 h-4 mr-2" />
              我的收件夾
            </button>
          </div>

          <div className="flex items-center space-x-2 overflow-x-auto pb-2 md:pb-0">
             <span className="text-xs font-bold text-slate-400 whitespace-nowrap">模擬切換:</span>
             {STAFF_LIST.slice(0, 5).map(staff => (
               <button 
                key={staff.id}
                onClick={() => setCurrentUserId(staff.id)}
                className={`text-[10px] px-3 py-1.5 rounded-lg border font-bold transition-all ${currentUserId === staff.id ? 'bg-[#4A8F88] text-white border-[#4A8F88]' : 'bg-white text-slate-500 border-slate-200'}`}
               >
                 {formatName(staff.name)}
               </button>
             ))}
          </div>
        </div>

        {activeTab === 'lobby' ? (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
            {/* 左側數據彙整 */}
            <div className="lg:col-span-4 space-y-6">
              <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-[#E0F2F0] relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-[#81D8D0]/10 rounded-full -mr-16 -mt-16"></div>
                <h3 className="text-slate-400 font-bold text-sm mb-2 flex items-center">
                  <AlertCircle className="w-4 h-4 mr-2 text-amber-400" />
                  待全員簽署公告
                </h3>
                <div className="text-6xl font-black text-[#4A8F88] tracking-tighter mb-4">
                  {incompleteAnnouncements.length}
                </div>
                <p className="text-xs text-slate-400 leading-relaxed font-medium">
                  目前有 {incompleteAnnouncements.length} 則公告尚未達到 100% 簽署率，請相關負責人督促讀取進度。
                </p>
              </div>

              <div className="bg-[#4A8F88] p-8 rounded-[2rem] shadow-xl text-white">
                <h3 className="text-white/70 font-bold text-sm mb-4">智生活・高效執行</h3>
                <p className="text-lg font-medium leading-snug">
                  「溝通的意義，在於對方的回應。」<br/>確保每一則資訊都被準確傳達與執行。
                </p>
              </div>
            </div>

            {/* 右側待簽清單 */}
            <div className="lg:col-span-8 space-y-6">
              <h2 className="text-xl font-black text-slate-800 flex items-center">
                <Clock className="w-6 h-6 mr-3 text-[#81D8D0]" />
                即時追蹤進度
              </h2>
              {incompleteAnnouncements.map(ann => {
                const unreadStaff = STAFF_LIST.filter(s => ann.targetStaffIds.includes(s.id) && !ann.readBy.includes(s.id));
                const progress = Math.round((ann.readBy.length / ann.targetStaffIds.length) * 100);
                
                return (
                  <div key={ann.id} className="bg-white rounded-[1.5rem] border border-[#E0F2F0] shadow-sm overflow-hidden group hover:border-[#81D8D0] transition-all">
                    <div className="p-6">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <div className="flex items-center space-x-2 mb-2">
                            {ann.priority === 'high' && <span className="bg-red-50 text-red-500 text-[10px] font-black px-2 py-0.5 rounded-md">HIGH</span>}
                            <h4 className="font-black text-lg text-slate-800">{ann.title}</h4>
                          </div>
                          <div className="flex items-center text-xs text-slate-400 font-bold space-x-3">
                            <span>發佈：{STAFF_LIST.find(s => s.id === ann.authorId).name}</span>
                            <span>•</span>
                            <span>{ann.createdAt}</span>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-black text-[#4A8F88]">{progress}%</div>
                          <div className="text-[10px] font-bold text-slate-300 uppercase">閱讀進度</div>
                        </div>
                      </div>

                      {/* 進度條 */}
                      <div className="w-full h-1.5 bg-slate-100 rounded-full mb-6">
                        <div className="h-full bg-[#81D8D0] rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                      </div>

                      <div className="space-y-3">
                        <div className="flex items-center text-xs font-black text-amber-500 bg-amber-50 w-fit px-3 py-1 rounded-full">
                          <UserCheck className="w-3 h-3 mr-1.5" />
                          尚未完成對象 ({unreadStaff.length})
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {unreadStaff.map(staff => (
                            <span key={staff.id} className="text-[11px] font-bold px-3 py-1.5 bg-white border border-slate-100 rounded-xl text-slate-600 shadow-sm">
                              {formatName(staff.name)}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {myRelevantAnnouncements.map(ann => {
              const isRead = ann.readBy.includes(currentUserId);
              return (
                <div 
                  key={ann.id}
                  onClick={() => setSelectedAnn(ann)}
                  className={`p-6 rounded-3xl border cursor-pointer transition-all hover:shadow-lg flex items-center justify-between group ${isRead ? 'bg-white border-slate-100' : 'bg-white border-[#81D8D0] ring-1 ring-[#81D8D0]'}`}
                >
                  <div className="flex items-center space-x-4">
                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all ${isRead ? 'bg-slate-50 text-slate-300' : 'bg-[#E0F2F0] text-[#4A8F88] group-hover:scale-110'}`}>
                      {isRead ? <CheckCircle className="w-7 h-7" /> : <Bell className="w-7 h-7" />}
                    </div>
                    <div>
                      <h4 className={`font-black text-lg ${isRead ? 'text-slate-500' : 'text-slate-900'}`}>{ann.title}</h4>
                      <p className="text-xs text-slate-400 font-bold mt-1">發佈者: {STAFF_LIST.find(s => s.id === ann.authorId).name}</p>
                    </div>
                  </div>
                  <ChevronRight className={`w-5 h-5 transition-transform group-hover:translate-x-1 ${isRead ? 'text-slate-200' : 'text-[#81D8D0]'}`} />
                </div>
              );
            })}
          </div>
        )}
      </main>

      {/* 公告發佈彈窗 */}
      {showCreateModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#4A8F88]/40 backdrop-blur-md animate-in fade-in duration-300">
          <div className="bg-white w-full max-w-4xl max-h-[90vh] rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">
            <div className="p-8 border-b flex justify-between items-center bg-[#F7FBFA]">
              <div>
                <h2 className="text-2xl font-black text-[#4A8F88]">發佈新公告</h2>
                <p className="text-xs font-bold text-slate-400 mt-1">請填寫內容並指定必讀人員</p>
              </div>
              <button onClick={() => setShowCreateModal(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X className="w-6 h-6 text-slate-400" /></button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
              {/* 左側編輯 */}
              <div className="space-y-6">
                <div className="space-y-2">
                  <label className="text-sm font-black text-slate-600">公告標題</label>
                  <input 
                    type="text" 
                    placeholder="請輸入重點明確的標題..."
                    className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-[#81D8D0] font-bold text-slate-800"
                    value={newAnn.title}
                    onChange={e => setNewAnn({...newAnn, title: e.target.value})}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-black text-slate-600">詳細內文</label>
                  <textarea 
                    rows="8"
                    placeholder="請輸入公告內容細節..."
                    className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-[#81D8D0] font-medium text-slate-700 resize-none"
                    value={newAnn.content}
                    onChange={e => setNewAnn({...newAnn, content: e.target.value})}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-black text-slate-600">緊急程度</label>
                  <div className="flex space-x-2">
                    {['normal', 'high'].map(p => (
                      <button 
                        key={p}
                        onClick={() => setNewAnn({...newAnn, priority: p})}
                        className={`px-6 py-2 rounded-xl font-bold text-sm transition-all border ${newAnn.priority === p ? 'bg-[#4A8F88] border-[#4A8F88] text-white shadow-md' : 'bg-white text-slate-400 border-slate-200'}`}
                      >
                        {p === 'normal' ? '一般' : '緊急'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* 右側對象選擇 */}
              <div className="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 flex flex-col">
                <div className="flex justify-between items-center mb-4">
                  <label className="text-sm font-black text-[#4A8F88] flex items-center">
                    <Users className="w-4 h-4 mr-2" />
                    指定必讀人員 ({newAnn.targetStaffIds.length})
                  </label>
                  <button 
                    onClick={() => setNewAnn({...newAnn, targetStaffIds: newAnn.targetStaffIds.length === STAFF_LIST.length ? [] : STAFF_LIST.map(s => s.id)})}
                    className="text-[10px] font-black text-slate-400 hover:text-[#4A8F88] uppercase"
                  >
                    {newAnn.targetStaffIds.length === STAFF_LIST.length ? '取消全員' : '選取全員'}
                  </button>
                </div>
                <div className="grid grid-cols-2 gap-2 overflow-y-auto max-h-[350px] pr-2">
                  {STAFF_LIST.map(staff => (
                    <button 
                      key={staff.id}
                      onClick={() => toggleTargetStaff(staff.id)}
                      className={`flex items-center px-3 py-2.5 rounded-xl border text-left transition-all ${newAnn.targetStaffIds.includes(staff.id) ? 'bg-[#81D8D0] border-[#81D8D0] text-white' : 'bg-white border-slate-200 text-slate-500 hover:border-[#81D8D0]'}`}
                    >
                      <div className={`w-2 h-2 rounded-full mr-2 ${newAnn.targetStaffIds.includes(staff.id) ? 'bg-white' : 'bg-slate-200'}`}></div>
                      <span className="text-xs font-bold truncate">{formatName(staff.name)} <span className="opacity-60 font-normal">({staff.title})</span></span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="p-8 border-t bg-[#F7FBFA] flex justify-end">
              <button 
                onClick={handleCreateAnnouncement}
                className="flex items-center px-10 py-4 bg-[#4A8F88] hover:bg-[#3d7a74] text-white rounded-2xl font-black shadow-lg shadow-[#4a8f8833] transition-all active:scale-95"
              >
                <Send className="w-5 h-5 mr-3" />
                立即發佈公告
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 閱讀公告詳情 */}
      {selectedAnn && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#2C524E]/80 backdrop-blur-sm animate-in fade-in zoom-in duration-200">
          <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden">
            <div className="p-10">
              <div className="flex justify-between items-start mb-8">
                <div className="space-y-2">
                  <div className="flex items-center space-x-2">
                    <span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase ${selectedAnn.priority === 'high' ? 'bg-red-50 text-red-500 border border-red-100' : 'bg-[#E0F2F0] text-[#4A8F88]'}`}>
                      {selectedAnn.priority === 'high' ? 'Priority Urgent' : 'General Notice'}
                    </span>
                  </div>
                  <h2 className="text-3xl font-black text-slate-800 leading-tight">{selectedAnn.title}</h2>
                  <div className="flex items-center space-x-2 text-xs font-bold text-slate-400">
                    <div className="w-6 h-6 rounded-full bg-[#E0F2F0] flex items-center justify-center text-[#4A8F88] text-[8px]">
                      {formatName(STAFF_LIST.find(s => s.id === selectedAnn.authorId).name)}
                    </div>
                    <span>{STAFF_LIST.find(s => s.id === selectedAnn.authorId).name} 於 {selectedAnn.createdAt} 發佈</span>
                  </div>
                </div>
                <button 
                  onClick={() => setSelectedAnn(null)}
                  className="p-3 hover:bg-slate-100 rounded-full text-slate-300 transition-colors"
                >
                  ✕
                </button>
              </div>
              
              <div className="bg-[#F7FBFA] p-8 rounded-[2rem] text-slate-700 leading-relaxed mb-10 min-h-[180px] border border-[#E0F2F0] font-medium shadow-inner">
                {selectedAnn.content}
              </div>

              <div className="flex flex-col space-y-4">
                {selectedAnn.readBy.includes(currentUserId) ? (
                  <div className="flex items-center justify-center space-x-3 text-[#4A8F88] bg-[#E0F2F0]/50 py-5 rounded-[1.5rem] border border-[#81D8D0]/30 animate-in slide-in-from-bottom-2 duration-500">
                    <CheckCircle className="w-6 h-6" />
                    <span className="font-black text-lg">您已完成詳讀確認</span>
                  </div>
                ) : (
                  <button 
                    onClick={() => handleConfirmRead(selectedAnn.id)}
                    className="w-full bg-[#81D8D0] hover:bg-[#6ec9c1] text-white font-black py-6 rounded-[1.5rem] shadow-xl shadow-[#81d8d044] transition-all hover:-translate-y-1 active:scale-95 flex items-center justify-center space-x-3 group"
                  >
                    <ClipboardCheck className="w-7 h-7 group-hover:rotate-12 transition-transform" />
                    <span className="text-xl">已詳讀且能具體遵守</span>
                  </button>
                )}
                <div className="flex items-center justify-center space-x-2 text-slate-300">
                  <span className="h-px w-8 bg-slate-100"></span>
                  <p className="text-[10px] font-bold uppercase tracking-widest">Acknowledgment Required</p>
                  <span className="h-px w-8 bg-slate-100"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
