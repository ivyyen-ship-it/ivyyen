<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ¶è²¼æ¨™ä½œæ¥­ä¸­å¿ƒ V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿å…§å®¹å€åŸŸä¸æœƒæº¢å‡º */
        .h-main { height: calc(100vh - 64px); }
        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }


        /* æ¨™ç±¤æŒ‰éˆ•æ¨£å¼ */
        .tag-btn {
            transition: all 0.15s;
            cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* æ¨™ç±¤é¸å–å¾Œçš„ç‹€æ…‹ */
        .tag-btn-active {
            background-color: #3b82f6 !important; /* Blue 500 */
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -2px rgba(59, 130, 246, 0.2) !important;
        }
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        /* è®“å³å´æ¬„çš„é—œéµæ¨¡çµ„å›ºå®šé«˜åº¦ï¼Œé¿å…æ»¾å‹•æ··äº‚ */
        .context-panel {
            min-height: 100%;
        }
    </style>
    <!-- Chosen Palette: Indigo & Blue (Professional, Clean, Trustworthy) -->
    <!-- Application Structure Plan: Dual-Column Layout (75%/25%). Left (A-Zone) is the main tagging form (Hard Tags, Hierarchical Flexible Tags). Right (B-Zone) combines Searchable List (Top), Manual Notes (Middle), and Cross-Product Status Modules (Bottom). This maximizes visibility of tagging context (B-Zone) while maintaining a focused, high-speed input area (A-Zone). -->
    <!-- Visualization & Content Choices: Heavy reliance on interactive forms (Dropdowns, Checkbox Buttons) and dynamic list rendering. Cross-product status uses dynamic module rendering for scalability. NO SVG/Mermaid used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-gray-50 text-gray-800 antialiased">


    <!-- Header -->
    <header class="bg-white shadow-md h-16 flex items-center px-6 z-10 sticky top-0">
        <h1 class="text-2xl font-bold text-indigo-600">å®¢æˆ¶è²¼æ¨™ä½œæ¥­ä¸­å¿ƒ</h1>
        <div class="ml-auto text-sm">
            å…¨é‡å®¢æˆ¶è²¼æ¨™ä½œæ¥­ï¼š<span id="progress-text" class="font-bold text-orange-500">0/200</span>
        </div>
    </header>


    <!-- Main Content Area: Two Columns -->
    <div class="flex h-main overflow-hidden">


        <!-- Column A (75%): Main Tagging Focus Area -->
        <main class="w-3/4 p-6 overflow-y-auto custom-scroll">
            <div id="tagging-detail-panel" class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-100 min-h-[500px]">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-2">
                    <span id="client-name-display">è«‹å¾å³å´åˆ—è¡¨é¸æ“‡ä¸€ä½å®¢æˆ¶é–‹å§‹è²¼æ¨™</span>
                </h2>
               
                <div id="detail-form-container" class="hidden">
                   
                    <!-- Basic Info Input/Editing -->
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">ğŸ“ å®¢æˆ¶åŸºæœ¬è³‡æ–™ (å¯ç·¨è¼¯)</h3>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-1">å®¢æˆ¶å§“å</label>
                            <input type="text" id="input-name" class="w-full border border-gray-300 p-2 rounded-lg text-gray-700" placeholder="ç‹å¤§æ˜">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">è¯çµ¡é›»è©±</label>
                            <input type="text" id="input-phone" class="w-full border border-gray-300 p-2 rounded-lg text-gray-700" placeholder="09xxxxxxxx">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1">å®¢æˆ¶ç·¨è™Ÿ</label>
                            <input type="text" id="input-id" class="w-full border border-gray-300 p-2 rounded-lg text-gray-500 bg-gray-100 cursor-not-allowed" readonly>
                        </div>
                    </div>


                    <!-- Section 1: Hard Tags (Mandatory, Single Select) -->
                    <h3 class="text-xl font-semibold text-indigo-600 mt-6 mb-4 border-t pt-4">ğŸ¯ ä¸€ã€åŸºç¤å±¬æ€§ (Hard Tags) - å¿…å¡«</h3>
                    <p class="text-sm text-gray-500 mb-4">ç”¨é€”ï¼šåˆ†çœ¾ã€æ´¾å·¥ã€å®šåƒ¹ã€‚è«‹å‹™å¿…é€éä¸‹æ‹‰é¸å–®å¡«å¯«ä»¥ç¢ºä¿è³‡æ–™æ¨™æº–åŒ–ã€‚</p>


                    <div id="hard-tag-dropdowns" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Dropdowns injected by JS -->
                    </div>


                    <!-- Section 2: Flexible Tags (Multi Select, Hierarchical Accordion) -->
                    <h3 class="text-xl font-semibold text-indigo-600 mt-8 mb-4 border-t pt-4">âœ… å½ˆæ€§æ¨™ç±¤ (Soft/Other Tags) - å‹¾é¸åˆ¶</h3>
                    <p class="text-sm text-gray-500 mb-4">æ¯æ¬¡æœå‹™å¾Œåªè£œ 1â€“2 å€‹æ–°æ¨™ç±¤ï¼Œä¸è¿½æ±‚ä¸€æ¬¡è²¼æ»¿ã€‚é»æ“Šæ¨™é¡Œå±•é–‹é¸é …ã€‚</p>
                   
                    <div id="flexible-tag-accordions" class="space-y-3">
                        <!-- Accordion sections injected by JS -->
                    </div>


                    <!-- Action Button -->
                    <div class="mt-8 pt-4 border-t">
                        <button onclick="saveAndNext()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg text-lg shadow-xl transition-all">
                            ğŸ’¾ å„²å­˜æ¨™ç±¤ä¸¦å‰å¾€ä¸‹ä¸€ä½å®¢æˆ¶ (Save & Next)
                        </button>
                    </div>


                </div>
            </div>
        </main>


        <!-- Column B (25%): Context Panel & List (Right Sidebar) -->
        <aside class="w-1/4 bg-gray-100 border-l border-gray-200 overflow-y-auto custom-scroll p-4 context-panel">
           
            <!-- B1: Client List & Search -->
            <div class="sticky top-0 bg-gray-100 pt-0 pb-3 z-10">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">å®¢æˆ¶åˆ—è¡¨èˆ‡æœå°‹</h3>
                <div class="flex space-x-2 mb-3">
                     <input type="text" id="client-search" oninput="searchClientList()" placeholder="ğŸ” æœå°‹å§“å/é›»è©±/ç·¨è™Ÿ" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div id="filter-status-info" class="text-xs text-gray-500 mb-2">é¡¯ç¤ºæ‰€æœ‰å®¢æˆ¶</div>
            </div>


            <div id="client-list" class="space-y-1 pb-4 border-b border-gray-300">
                <!-- Client items injected by JS -->
            </div>


            <!-- B2: Cross-Product Status Modules -->
            <div class="mt-4">
                <h3 class="text-lg font-semibold mb-3 text-blue-600 border-b pb-2">è·¨ç”¢å“ç·šç‹€æ…‹ (è¼”åŠ©æ±ºç­–)</h3>
                <div id="cross-product-modules" class="space-y-3 text-sm">
                    <!-- Modules injected by JS -->
                    <p id="no-client-context" class="text-gray-500 italic">è«‹é¸æ“‡å®¢æˆ¶ä»¥è¼‰å…¥ä¸Šä¸‹æ–‡è³‡è¨Šã€‚</p>
                </div>
            </div>
           
            <!-- B3: Manual Notes -->
            <div class="mt-6 pt-4 border-t border-gray-300">
                <h3 class="text-lg font-semibold mb-3 text-orange-600">ğŸ“ äººå·¥å‚™è¨» (500 å­—ä¸Šé™)</h3>
                <textarea id="manual-notes" maxlength="500" rows="4" placeholder="è«‹è¼¸å…¥æºé€šç´°ç¯€ã€ç‰¹æ®Šç‹€æ³ã€æˆ–é‡è¦è§€å¯Ÿ..." class="w-full p-2 border border-gray-300 rounded-lg text-sm resize-none" disabled></textarea>
                <div class="text-xs text-right text-gray-500">
                    å·²è¼¸å…¥: <span id="notes-char-count">0</span> / 500
                </div>
            </div>


        </aside>
    </div>


    <!-- Notification Box -->
    <div id="notification-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 z-50">
        å„²å­˜æˆåŠŸï¼
    </div>
   
    <!-- Export Modal (Simplified for SPA) -->
    <div id="export-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">åŒ¯å‡ºå®¢æˆ¶è³‡æ–™</h3>
            <p class="mb-4">å°‡åŒ¯å‡ºç›®å‰ç¯©é¸çµæœ (<span id="export-count-display">0</span> ä½å®¢æˆ¶) çš„å®Œæ•´æ¨™ç±¤è³‡æ–™ã€‚</p>
            <div id="filter-conditions-display" class="bg-gray-100 p-3 rounded text-sm mb-4"></div>
            <p class="text-red-500 text-xs mb-4">æ³¨æ„ï¼šæ­¤ç‚ºå‰ç«¯æ¨¡æ“¬åŒ¯å‡ºï¼Œå°‡ä¸‹è¼‰ CSV æª”æ¡ˆã€‚</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('export-modal')" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                <button onclick="confirmExport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ç¢ºèªåŒ¯å‡º CSV</button>
            </div>
        </div>
    </div>




    <script>
        // --- 1. Master Data Storage & Definitions ---
        let clients = [];
        let currentClientIndex = -1;
        let isSearchActive = false; // Flag to track if search/filter is active


        const TAG_CATEGORIES = {
            // A. åŸºç¤å±¬æ€§ (Hard Tags) - Mandatory, Single Select
            hardTags: {
                title: 'ä¸€ã€åŸºç¤å±¬æ€§',
                type: 'single',
                fields: {
                    residenceCondition: {
                        label: 'å±…ä½æ¢ä»¶',
                        options: ['ç¤¾å€å¤§æ¨“(æœ‰ç®¡ç†å®¤)', 'ç¤¾å€å¤§æ¨“(ç„¡ç®¡ç†å®¤)', 'é€å¤©', 'è€å…¬å¯“(ç„¡é›»æ¢¯)', 'æ–°æˆå±‹(5å¹´å…§)', 'ä¸­å¤å±‹(10å¹´ä»¥ä¸Š)', 'é ‚æ¨“æˆ¶', 'ä½æ¨“å±¤(1â€“2æ¨“)']
                    },
                    familyStructure: {
                        label: 'å®¶åº­çµæ§‹',
                        options: ['å–®èº«', 'é›™è–ªå¤«å¦»', 'å°å®¶åº­(1â€“2ä½å°å­©)', 'å¤šå­©å®¶åº­(3äººä»¥ä¸Š)', 'ä¸‰ä»£åŒå ‚', 'é•·è¼©åŒä½']
                    },
                    ageGroup: {
                        label: 'å¹´é½¡å€é–“(æ±ºç­–è€…)',
                        options: ['25â€“34', '35â€“44', '45â€“54', '55+']
                    },
                    spaceType: {
                        label: 'ç©ºé–“å‹æ…‹',
                        options: ['å¥—æˆ¿/1æˆ¿', '2æˆ¿', '3æˆ¿', '4æˆ¿ä»¥ä¸Š', 'å…¬è¨­å¤š(å¤§ç¤¾å€)']
                    }
                }
            },
            // B. å½ˆæ€§æ¨™ç±¤ (Soft/Other Tags) - Multi Select
            softTags: {
                title: 'äºŒã€ç”Ÿæ´»å‹æ…‹ (Soft Tags)',
                type: 'multi',
                subgroups: [
                    { label: 'ç”Ÿæ´»ç¯€å¥', tags: ['å·¥ä½œå¿™ç¢Œ/åŠ ç­å‹', 'å›ºå®šå±…å®¶ä½œæ¯', 'å‡æ—¥æ‰æœ‰ç©º', 'å¸¸å‡ºå·®', 'é•·æ™‚é–“ä¸åœ¨å®¶'] },
                    { label: 'å®¶åº­ç…§é¡§éœ€æ±‚', tags: ['æœ‰å¹¼å…’(0â€“6æ­²)', 'æœ‰å­¸é½¡å­©ç«¥', 'æœ‰é•·è¼©éœ€è¦ç…§é¡§', 'å­•æœŸ/ç”¢å¾Œ', 'è¡Œå‹•ä¸ä¾¿å®¶äºº'] },
                    { label: 'å¥åº·èˆ‡æ½”æ·¨æ„è­˜', tags: ['å°ç°å¡µæ•æ„Ÿ', 'æœ‰éæ•é«”è³ª', 'åœ¨æ„é»´èŒ/æ°£å‘³', 'é«˜æ½”ç™–', 'ä¸€èˆ¬å³å¯'] },
                    { label: 'å·¥ä½œå‹æ…‹', tags: ['åœ¨å®¶å·¥ä½œ(WFH)', 'æ··åˆè¾¦å…¬', 'å…¨å¤–å‹¤', 'é€€ä¼‘åœ¨å®¶'] }
                ]
            },
            transactionTags: {
                title: 'ä¸‰ã€æ¶ˆè²»è¡Œç‚º (Transaction Tags)',
                type: 'multi',
                subgroups: [
                    { label: 'æ¸…æ½”ä½¿ç”¨ç¿’æ…£', tags: ['ç¬¬ä¸€æ¬¡æ‰¾æ¸…æ½”', 'æ›¾ç”¨éå¹³å°å‹æ¸…æ½”', 'å›ºå®šæ¸…æ½”ç¿’æ…£', 'ä¸å›ºå®š/æœ‰ç©ºæ‰æ‰¾', 'åªåœ¨ç¯€æ—¥å‰æ¸…æ½”'] },
                    { label: 'é »ç‡åå¥½', tags: ['é »ç‡:æ¯é€±', 'é »ç‡:é›™é€±', 'é »ç‡:æ¯æœˆ', 'é »ç‡:ä¸å›ºå®š'] },
                    { label: 'åƒ¹æ ¼æ•æ„Ÿåº¦', tags: ['åƒ¹æ ¼å°å‘', 'å“è³ªå°å‘', 'å“ç‰Œä¿¡ä»»å°å‘', 'å¯æ¥å—åŠ åƒ¹æ›å®‰å¿ƒ'] },
                    { label: 'æŒ‡å®šåå¥½', tags: ['æŒ‡å®šå®¶æ”¿å¸«', 'å¸Œæœ›åŒä¸€ä½', 'ä¸æŒ‡å®š', 'å¥³æ€§å®¶æ”¿å¸«', 'ç†Ÿæ‰‹å„ªå…ˆ'] }
                ]
            },
            riskTags: {
                title: 'å››ã€æœå‹™é¢¨éšª (Risk Tags)',
                type: 'multi',
                subgroups: [
                    { label: 'æºé€šé¢¨éšª', tags: ['å°ç´°ç¯€éå¸¸è¦æ±‚', 'å®¹æ˜“åè¦†ç¢ºèª', 'èªªæ˜å¾Œä»ä¸æ”¾å¿ƒ', 'è¡¨é”æƒ…ç·’å¼·çƒˆ'] },
                    { label: 'æœŸå¾…è½å·®é¢¨éšª', tags: ['å°ã€Œå¾ˆä¹¾æ·¨ã€å®šç¾©é«˜', 'æ›¾å°å…¶ä»–æ¥­è€…ä¸æ»¿', 'æ›¾å®¢è¨´ç¶“é©—', 'æ¯”è¼ƒå‹å®¢æˆ¶'] },
                    { label: 'ç¾å ´é™åˆ¶', tags: ['ç©ºé–“é›œç‰©å¤š', 'æ”¶ç´ä¸è¶³', 'æ¸…æ½”æ­»è§’å¤š', 'è£æ½¢æ€•åˆ®å‚·'] }
                ]
            },
            preferenceTags: {
                title: 'äº”ã€é—œéµåå¥½æ¨™ç±¤',
                type: 'multi',
                subgroups: [
                    { label: 'å®¢æˆ¶æœ€å–œæ­¡', tags: ['æœ€å–œæ­¡:æº–æ™‚', 'æœ€å–œæ­¡:ç´°å¿ƒ', 'æœ€å–œæ­¡:å®‰éœä¸æ‰“æ“¾', 'æœ€å–œæ­¡:ä¸»å‹•æé†’', 'æœ€å–œæ­¡:å›ºå®šäººå“¡', 'æœ€å–œæ­¡:æœ‰åˆ¶åº¦æœ‰å›å ±'] },
                    { label: 'å®¢æˆ¶æœ€è¨å­', tags: ['æœ€è¨å­:é²åˆ°', 'æœ€è¨å­:æ›äºº', 'æœ€è¨å­:æ¸…ä¸ä¹¾æ·¨', 'æœ€è¨å­:ä¸ç…§èªªæ˜åš', 'æœ€è¨å­:ä¸€ç›´æ¨éŠ·', 'æœ€è¨å­:èªæ°£ä¸ä½³'] },
                    { label: 'å®¢æˆ¶æœ€åœ¨æ„', tags: ['æœ€åœ¨æ„:å®¶äººå¥åº·', 'æœ€åœ¨æ„:å­©å­å®‰å…¨', 'æœ€åœ¨æ„:æ¸…æ½”æ•ˆæœ', 'æœ€åœ¨æ„:æ˜¯å¦å‚·å®¶å…·', 'æœ€åœ¨æ„:æ˜¯å¦ç©©å®šé•·æœŸ', 'æœ€åœ¨æ„:å”®å¾Œæ˜¯å¦æœ‰äººç®¡'] }
                ]
            }
        };


        // --- 2. Initialization and Dummy Data Generation ---


        function generateDummyClients() {
            const statusOptions = ['æœŸä¸­å®¢æˆ¶', 'å·²åˆ°æœŸå®¢æˆ¶', 'å·²é€€ç§Ÿå®¢æˆ¶'];
            for (let i = 1; i <= 200; i++) {
                const isBBUser = Math.random() > 0.4;
                const isCleaned = Math.random() > 0.3;
               
                let bbStatus = [];
                if(isBBUser) {
                    // Simulate multi-select status
                    if(Math.random() > 0.8) bbStatus.push('å¯æ¨éŠ·å‡ç´š');
                    bbStatus.push(statusOptions[Math.floor(Math.random() * statusOptions.length)]);
                }


                clients.push({
                    clientId: 'C' + i.toString().padStart(4, '0'),
                    name: 'å®¢æˆ¶ ' + String.fromCharCode(65 + Math.floor(Math.random() * 26)) + i,
                    phone: '09' + (10000000 + i),
                    manualNotes: '',
                    // Hard Tags - initialize empty strings
                    residenceCondition: '',
                    familyStructure: '',
                    ageGroup: '',
                    spaceType: '',
                    flexibleTags: [],
                    isTagged: false,
                    // Cross-Product Status
                    crossProductStatus: {
                        broadband: {
                            isUser: isBBUser,
                            status: bbStatus
                        },
                        applianceCleaning: {
                            lastCleanDate: isCleaned ? `2024-${Math.floor(Math.random() * 12) + 1}-${Math.floor(Math.random() * 28) + 1}` : 'N/A',
                            unitsCleaned: isCleaned ? Math.floor(Math.random() * 4) + 1 : 0
                        },
                        moduleA: {
                            productName: 'æ™ºèƒ½é–æœå‹™',
                            status: Math.random() > 0.7 ? 'å·²å®‰è£' : 'æ½›åœ¨å®¢æˆ¶',
                            data: Math.random() > 0.7 ? 'é–å‹: P50' : null
                        },
                        moduleB: {
                            productName: 'å®¶é›»ç§Ÿè³ƒæœå‹™',
                            status: Math.random() > 0.9 ? 'å·²ç°½ç´„' : 'éç”¨æˆ¶',
                            data: null
                        }
                    }
                });
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            generateDummyClients();
            renderHardTagDropdowns();
            renderFlexibleTagAccordions();
            // Initial render uses all clients
            renderClientList();
            updateProgress();
           
            // Set up character counter for manual notes
            const notesInput = document.getElementById('manual-notes');
            notesInput.addEventListener('input', updateCharCount);
           
            // Auto select the first client to start tagging
            selectNextClientToTag();
        });




        // --- 3. Rendering Functions (Hard Tags, Flexible Tags, List) ---
       
        function updateCharCount() {
            const input = document.getElementById('manual-notes');
            const countSpan = document.getElementById('notes-char-count');
            countSpan.innerText = input.value.length;
        }


        function renderClientList(filteredClients = clients) {
            const listContainer = document.getElementById('client-list');
            listContainer.innerHTML = '';
           
            // Sort by isTagged status (untagged first)
            filteredClients.sort((a, b) => a.isTagged - b.isTagged);


            filteredClients.forEach(client => {
                const item = document.createElement('div');
                const isCurrent = client.clientId === clients[currentClientIndex]?.clientId;
                const statusColor = client.isTagged ? 'text-green-600' : 'text-orange-500';
                const statusText = client.isTagged ? 'âœ…' : 'â³';
                const bgColor = isCurrent ? 'bg-indigo-100 border-indigo-500' : 'hover:bg-gray-100 border-transparent';
                const textColor = isCurrent ? 'font-bold' : 'font-medium';


                item.className = `p-2 rounded-lg cursor-pointer text-sm border ${bgColor} transition`;
                item.innerHTML = `
                    <div class="${textColor} flex justify-between items-center">
                        <span>${client.name}</span>
                        <span class="text-xs font-normal text-gray-500">${client.clientId}</span>
                    </div>
                    <div class="text-xs flex justify-between">
                        <span class="${statusColor} flex items-center">${statusText} ${client.isTagged ? 'å·²è²¼æ¨™' : 'å¾…è™•ç†'}</span>
                        <span class="text-gray-500">${client.phone}</span>
                    </div>
                `;
                item.onclick = () => selectClient(client.clientId);
                listContainer.appendChild(item);
            });
           
            const totalClients = clients.length;
            const currentDisplayCount = filteredClients.length;
            const filterInfo = document.getElementById('filter-status-info');
            if (currentDisplayCount < totalClients) {
                filterInfo.innerText = `ç¯©é¸ä¸­ï¼šå…± ${currentDisplayCount} ä½å®¢æˆ¶ç¬¦åˆæ¢ä»¶`;
                isSearchActive = true;
            } else {
                filterInfo.innerText = `é¡¯ç¤ºæ‰€æœ‰å®¢æˆ¶ (200)`;
                isSearchActive = false;
            }
        }


        function updateProgress() {
            const taggedCount = clients.filter(c => c.isTagged).length;
            document.getElementById('progress-text').innerText = `${taggedCount}/200`;
        }


        // Render Hard Tag Dropdowns (Same as V2)
        function renderHardTagDropdowns() {
            const container = document.getElementById('hard-tag-dropdowns');
            container.innerHTML = '';
            for (const key in TAG_CATEGORIES.hardTags.fields) {
                const field = TAG_CATEGORIES.hardTags.fields[key];
                const div = document.createElement('div');
                const id = `tag-${key}`;
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium mb-1 text-gray-700';
                label.innerText = field.label;
                const select = document.createElement('select');
                select.id = id;
                select.className = 'w-full border border-gray-300 p-2 rounded-lg bg-white text-gray-700 text-sm';
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
                field.options.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.innerText = optionText;
                    select.appendChild(option);
                });
                div.appendChild(label);
                div.appendChild(select);
                container.appendChild(div);
            }
        }


        // Render Flexible Tag Accordions (Same as V2)
        function renderFlexibleTagAccordions() {
            const container = document.getElementById('flexible-tag-accordions');
            container.innerHTML = '';
            for (const categoryKey in TAG_CATEGORIES) {
                if (TAG_CATEGORIES[categoryKey].type === 'single') continue;
                const category = TAG_CATEGORIES[categoryKey];
                const accordionId = `acc-${categoryKey}`;
                const panel = document.createElement('div');
                panel.className = 'border border-gray-200 rounded-lg overflow-hidden shadow-sm';
                const header = document.createElement('div');
                header.className = 'accordion-header bg-gray-100 hover:bg-gray-200 p-4 font-semibold text-gray-700 flex justify-between items-center';
                header.innerHTML = `<span>${category.title}</span><span class="text-sm text-gray-500">é»æ“Šå±•é–‹</span>`;
                header.onclick = () => toggleAccordion(accordionId);
                const content = document.createElement('div');
                content.id = accordionId;
                content.className = 'p-4 bg-white hidden';
                category.subgroups.forEach(group => {
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'font-medium text-indigo-700 border-b border-indigo-100 pb-1 mb-2 mt-4 first:mt-0';
                    groupTitle.innerText = group.label;
                    content.appendChild(groupTitle);
                    const tagContainer = document.createElement('div');
                    tagContainer.className = 'flex flex-wrap gap-2';
                    group.tags.forEach(tag => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'tag-btn text-sm px-3 py-1.5 rounded-full border border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100';
                        button.innerText = tag;
                        button.dataset.tag = tag;
                        button.onclick = toggleFlexibleTag;
                        tagContainer.appendChild(button);
                    });
                    content.appendChild(tagContainer);
                });
                panel.appendChild(header);
                panel.appendChild(content);
                container.appendChild(panel);
            }
        }


        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const isHidden = content.classList.contains('hidden');
           
            document.querySelectorAll('#flexible-tag-accordions > div > div:nth-child(2)').forEach(c => {
                if (c.id !== id) c.classList.add('hidden');
            });


            if (isHidden) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        }


        // --- 4. Client Selection and Form Population ---


        function selectClient(clientId) {
            const index = clients.findIndex(c => c.clientId === clientId);
            if (index === -1) return;


            currentClientIndex = index;
            const client = clients[currentClientIndex];


            // 1. Update Left List UI
            renderClientList();


            // 2. Update Detail Panel (A-Zone)
            document.getElementById('client-name-display').innerText = `æ­£åœ¨è²¼æ¨™ï¼š${client.name} (${client.clientId})`;
            document.getElementById('detail-form-container').classList.remove('hidden');
           
            // Basic Info Input
            document.getElementById('input-name').value = client.name;
            document.getElementById('input-phone').value = client.phone;
            document.getElementById('input-id').value = client.clientId;


            // Hard Tags (Dropdowns)
            for (const key in TAG_CATEGORIES.hardTags.fields) {
                document.getElementById(`tag-${key}`).value = client[key] || '';
            }


            // Flexible Tags (Buttons)
            const allTagButtons = document.querySelectorAll('.tag-btn');
            allTagButtons.forEach(btn => {
                const tag = btn.dataset.tag;
                if (client.flexibleTags.includes(tag)) {
                    btn.classList.add('tag-btn-active');
                } else {
                    btn.classList.remove('tag-btn-active');
                }
            });
           
            // 3. Update Context Panel (B-Zone)
            const notesInput = document.getElementById('manual-notes');
            notesInput.value = client.manualNotes;
            notesInput.disabled = false;
            updateCharCount();
            renderCrossProductStatus(client.crossProductStatus);
           
            // Scroll to top of the main tagging content area for better UX
            document.querySelector('main').scrollTo(0, 0);
        }


        function selectNextClientToTag() {
            // Find the next untagged client in the current client array (not filtered list)
            const nextIndex = clients.findIndex(c => !c.isTagged);
            if (nextIndex !== -1) {
                selectClient(clients[nextIndex].clientId);
            } else {
                 document.getElementById('client-name-display').innerText = 'ğŸ‰ æ­å–œï¼æ‰€æœ‰å®¢æˆ¶å·²å®Œæˆè²¼æ¨™ï¼';
                 document.getElementById('detail-form-container').classList.add('hidden');
                 document.getElementById('manual-notes').disabled = true;
            }
        }


        function renderCrossProductStatus(statusData) {
            const container = document.getElementById('cross-product-modules');
            container.innerHTML = '';
            document.getElementById('no-client-context').classList.add('hidden');
           
            for (const key in statusData) {
                const module = statusData[key];
                const card = document.createElement('div');
                card.className = 'p-3 rounded-lg border shadow-sm';
               
                let content = '';


                if (key === 'broadband') {
                    const isUserText = module.isUser ? 'âœ… ç”¨æˆ¶' : 'âŒ éç”¨æˆ¶';
                    const statusText = module.status.length > 0 ? module.status.join(', ') : 'ç„¡ç‰¹æ®Šç‹€æ…‹';
                    const color = module.isUser ? 'border-blue-300 bg-blue-50' : 'border-gray-300 bg-gray-50';
                    card.className += ' ' + color;


                    content = `
                        <p class="font-bold text-blue-800">ä»Šç¶²å¯¬é »ç‹€æ…‹</p>
                        <p class="text-xs mt-1">ç”¨æˆ¶èº«ä»½: <span class="font-semibold">${isUserText}</span></p>
                        <p class="text-xs">ç‹€æ…‹æ¨™ç±¤: <span class="text-orange-600 font-semibold">${statusText}</span></p>
                    `;
                } else if (key === 'applianceCleaning') {
                    const statusText = module.unitsCleaned > 0 ? `${module.unitsCleaned} å°` : 'ç„¡æ¸…æ´—ç´€éŒ„';
                    const dateText = module.lastCleanDate === 'N/A' ? 'N/A' : module.lastCleanDate;
                    const color = module.unitsCleaned > 0 ? 'border-emerald-300 bg-emerald-50' : 'border-gray-300 bg-gray-50';
                    card.className += ' ' + color;


                    content = `
                        <p class="font-bold text-emerald-800">æ™ºæ¨‚å®¶ï¼å®¶é›»æ¸…æ´—ç´€éŒ„</p>
                        <p class="text-xs mt-1">ä¸Šä¸€æ¬¡æ¸…æ´—: <span class="font-semibold">${dateText}</span></p>
                        <p class="text-xs">ç¸½æ¸…æ´—å°æ•¸: <span class="font-semibold">${statusText}</span></p>
                    `;
                } else if (key.startsWith('module')) { // Future Expansion Modules
                    const statusColor = module.status === 'æ½›åœ¨å®¢æˆ¶' ? 'text-yellow-600' : module.status.includes('å·²') ? 'text-green-600' : 'text-gray-600';
                    const productName = module.productName || 'é ç•™ç”¢å“æ¨¡çµ„';
                    card.className += ' border-purple-300 bg-purple-50';
                   
                    content = `
                        <p class="font-bold text-purple-800">${productName} (æ“´å……)</p>
                        <p class="text-xs mt-1">ç•¶å‰ç‹€æ…‹: <span class="${statusColor} font-semibold">${module.status}</span></p>
                        ${module.data ? `<p class="text-xs text-purple-700 italic">å‚™è¨»: ${module.data}</p>` : ''}
                    `;
                }
               
                card.innerHTML = content;
                container.appendChild(card);
            }
        }


        // --- 5. Tagging & Saving Logic ---


        function toggleFlexibleTag() {
            this.classList.toggle('tag-btn-active');
        }


        function saveAndNext() {
            if (currentClientIndex === -1) return;


            const client = clients[currentClientIndex];
           
            // 1. Get Editable Basic Info
            client.name = document.getElementById('input-name').value.trim();
            client.phone = document.getElementById('input-phone').value.trim();
           
            // 2. Get Hard Tag Values (A Categories)
            let allHardTagsSelected = true;
            for (const key in TAG_CATEGORIES.hardTags.fields) {
                const value = document.getElementById(`tag-${key}`).value;
                client[key] = value;
                if (!value) allHardTagsSelected = false;
            }


            // 3. Check for mandatory fields (Hard Tags + Name/Phone)
            if (!client.name || !client.phone || !allHardTagsSelected) {
                showNotification('ğŸš¨ éŒ¯èª¤ï¼šè«‹ç¢ºä¿å®¢æˆ¶å§“å/é›»è©±åŠæ‰€æœ‰åŸºç¤å±¬æ€§ (Hard Tags) çš†å·²å¡«å¯«ï¼', 'bg-red-600');
                return;
            }


            // 4. Get Flexible Tag Values
            client.flexibleTags = [];
            document.querySelectorAll('.tag-btn-active').forEach(btn => {
                client.flexibleTags.push(btn.dataset.tag);
            });
           
            // 5. Get Manual Notes
            client.manualNotes = document.getElementById('manual-notes').value.trim();


            // 6. Update Status and Save
            client.isTagged = true;
           
            // 7. Success Feedback and Next
            showNotification(`âœ… å®¢æˆ¶ ${client.clientId} å„²å­˜æˆåŠŸï¼å·²è‡ªå‹•è·³è½‰ã€‚`, 'bg-green-600');
            updateProgress();
           
            // If currently filtering/searching, we re-render the list to keep the filtered view
            if (isSearchActive) {
                searchClientList(); // Re-render filtered list (current client will be unhighlighted)
            } else {
                selectNextClientToTag();
            }
        }


        function showNotification(message, bgColor) {
            const box = document.getElementById('notification-box');
            box.innerText = message;
            box.className = `fixed bottom-4 left-1/2 -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl transition-opacity duration-300 opacity-100 z-50`;
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
            }, 3000);
        }


        // --- 6. Search and Export Logic ---


        function searchClientList() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase().trim();
            const filtered = clients.filter(c =>
                c.name.toLowerCase().includes(searchTerm) ||
                c.phone.includes(searchTerm) ||
                c.clientId.toLowerCase().includes(searchTerm)
            );
            renderClientList(filtered);
        }


        function openExportModal() {
            // Get the currently displayed list
            const clientItems = document.getElementById('client-list').children;
            const currentDisplayCount = clientItems.length;
           
            // If search/filter is active, update conditions display
            let conditionText = 'ç„¡ç¯©é¸æ¢ä»¶ (åŒ¯å‡ºæ‰€æœ‰å®¢æˆ¶)';
            if (isSearchActive) {
                const searchTerm = document.getElementById('client-search').value.trim();
                conditionText = `ç¯©é¸æ¢ä»¶: é—œéµå­—åŒ…å« "${searchTerm}"`;
            }


            document.getElementById('export-count-display').innerText = currentDisplayCount;
            document.getElementById('filter-conditions-display').innerText = conditionText;
            document.getElementById('export-modal').classList.remove('hidden');
        }


        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }


        function confirmExport() {
            // Get the list of clients currently displayed in the UI
            const clientIdsOnScreen = Array.from(document.getElementById('client-list').children).map(el => el.querySelector('.text-xs.font-normal.text-gray-500').innerText);
            const currentList = clients.filter(c => clientIdsOnScreen.includes(c.clientId));
           
            if (currentList.length === 0) {
                 showNotification('âš ï¸ ç„¡å®¢æˆ¶å¯åŒ¯å‡ºã€‚', 'bg-red-500');
                 closeModal('export-modal');
                 return;
            }


            let csvContent = "data:text/csv;charset=utf-8,";
           
            // 1. Headers
            let headers = ["ID", "å§“å", "é›»è©±", "å‚™è¨»"];
            // Add all Hard Tag keys as headers
            for (const key in TAG_CATEGORIES.hardTags.fields) {
                headers.push(TAG_CATEGORIES.hardTags.fields[key].label);
            }
            headers.push("æ‰€æœ‰å½ˆæ€§æ¨™ç±¤");
            headers.push("ä»Šç¶²å¯¬é »ç‹€æ…‹", "å®¶é›»æ¸…æ´—-ä¸Šæ¬¡æ—¥æœŸ", "å®¶é›»æ¸…æ´—-å°æ•¸", "æ“´å……æ¨¡çµ„A-ç”¢å“å", "æ“´å……æ¨¡çµ„A-ç‹€æ…‹", "æ“´å……æ¨¡çµ„B-ç”¢å“å", "æ“´å……æ¨¡çµ„B-ç‹€æ…‹");


            csvContent += headers.join(",") + "\n";


            // 2. Data rows
            currentList.forEach(client => {
                let row = [];
                row.push(client.clientId, client.name, client.phone, client.manualNotes);
               
                // Hard Tag values
                for (const key in TAG_CATEGORIES.hardTags.fields) {
                    row.push(client[key]);
                }
               
                // Flexible Tags
                row.push(client.flexibleTags.join(';'));
               
                // Cross-Product Status
                const cps = client.crossProductStatus;
                row.push(
                    (cps.broadband.isUser ? 'ç”¨æˆ¶:' : 'éç”¨æˆ¶:') + cps.broadband.status.join('|'),
                    cps.applianceCleaning.lastCleanDate,
                    cps.applianceCleaning.unitsCleaned,
                    cps.moduleA.productName, cps.moduleA.status,
                    cps.moduleB.productName, cps.moduleB.status
                );


                csvContent += row.map(e => `"${String(e).replace(/"/g, '""')}"`).join(",") + "\n";


            });


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "customer_tagging_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);


            showNotification(`âœ… ${currentList.length} ç­†å®¢æˆ¶è³‡æ–™å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆã€‚`, 'bg-green-700');
            closeModal('export-modal');
        }


    </script>
</body>
</html>

